var ur=Object.defineProperty;var sr=(s,i,a)=>i in s?ur(s,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[i]=a;var Ct=(s,i,a)=>(sr(s,typeof i!="symbol"?i+"":i,a),a);(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const f of document.querySelectorAll('link[rel="modulepreload"]'))c(f);new MutationObserver(f=>{for(const g of f)if(g.type==="childList")for(const l of g.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&c(l)}).observe(document,{childList:!0,subtree:!0});function a(f){const g={};return f.integrity&&(g.integrity=f.integrity),f.referrerpolicy&&(g.referrerPolicy=f.referrerpolicy),f.crossorigin==="use-credentials"?g.credentials="include":f.crossorigin==="anonymous"?g.credentials="omit":g.credentials="same-origin",g}function c(f){if(f.ep)return;f.ep=!0;const g=a(f);fetch(f.href,g)}})();function K(){}function vn(s){return s()}function rn(){return Object.create(null)}function Te(s){s.forEach(vn)}function Dt(s){return typeof s=="function"}function ke(s,i){return s!=s?i==i:s!==i||s&&typeof s=="object"||typeof s=="function"}function ar(s){return Object.keys(s).length===0}function cr(s){return s&&Dt(s.destroy)?s.destroy:K}function P(s,i){s.appendChild(i)}function re(s,i,a){s.insertBefore(i,a||null)}function te(s){s.parentNode&&s.parentNode.removeChild(s)}function Nt(s,i){for(let a=0;a<s.length;a+=1)s[a]&&s[a].d(i)}function U(s){return document.createElement(s)}function je(s){return document.createElementNS("http://www.w3.org/2000/svg",s)}function Ne(s){return document.createTextNode(s)}function de(){return Ne(" ")}function gn(){return Ne("")}function se(s,i,a,c){return s.addEventListener(i,a,c),()=>s.removeEventListener(i,a,c)}function R(s,i,a){a==null?s.removeAttribute(i):s.getAttribute(i)!==a&&s.setAttribute(i,a)}function _n(s){return s===""?null:+s}function lr(s){return Array.from(s.childNodes)}function on(s,i){i=""+i,s.wholeText!==i&&(s.data=i)}function ze(s,i){s.value=i==null?"":i}function pe(s,i,a,c){a===null?s.style.removeProperty(i):s.style.setProperty(i,a,c?"important":"")}function _e(s,i,a){s.classList[a?"add":"remove"](i)}function fr(s,i,{bubbles:a=!1,cancelable:c=!1}={}){const f=document.createEvent("CustomEvent");return f.initCustomEvent(s,a,c,i),f}let ot;function rt(s){ot=s}function bn(){if(!ot)throw new Error("Function called outside component initialization");return ot}function wn(s){bn().$$.on_mount.push(s)}function kn(){const s=bn();return(i,a,{cancelable:c=!1}={})=>{const f=s.$$.callbacks[i];if(f){const g=fr(i,a,{cancelable:c});return f.slice().forEach(l=>{l.call(s,g)}),!g.defaultPrevented}return!0}}const Ke=[],Re=[],dt=[],qt=[],hr=Promise.resolve();let jt=!1;function pr(){jt||(jt=!0,hr.then(xn))}function At(s){dt.push(s)}function Tt(s){qt.push(s)}const Et=new Set;let Ue=0;function xn(){if(Ue!==0)return;const s=ot;do{try{for(;Ue<Ke.length;){const i=Ke[Ue];Ue++,rt(i),dr(i.$$)}}catch(i){throw Ke.length=0,Ue=0,i}for(rt(null),Ke.length=0,Ue=0;Re.length;)Re.pop()();for(let i=0;i<dt.length;i+=1){const a=dt[i];Et.has(a)||(Et.add(a),a())}dt.length=0}while(Ke.length);for(;qt.length;)qt.pop()();jt=!1,Et.clear(),rt(s)}function dr(s){if(s.fragment!==null){s.update(),Te(s.before_update);const i=s.dirty;s.dirty=[-1],s.fragment&&s.fragment.p(s.ctx,i),s.after_update.forEach(At)}}const mt=new Set;let Pe;function Rt(){Pe={r:0,c:[],p:Pe}}function Qt(){Pe.r||Te(Pe.c),Pe=Pe.p}function fe(s,i){s&&s.i&&(mt.delete(s),s.i(i))}function me(s,i,a,c){if(s&&s.o){if(mt.has(s))return;mt.add(s),Pe.c.push(()=>{mt.delete(s),c&&(a&&s.d(1),c())}),s.o(i)}else c&&c()}const Cn=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function St(s,i,a){const c=s.$$.props[i];c!==void 0&&(s.$$.bound[c]=a,a(s.$$.ctx[c]))}function qe(s){s&&s.c()}function xe(s,i,a,c){const{fragment:f,after_update:g}=s.$$;f&&f.m(i,a),c||At(()=>{const l=s.$$.on_mount.map(vn).filter(Dt);s.$$.on_destroy?s.$$.on_destroy.push(...l):Te(l),s.$$.on_mount=[]}),g.forEach(At)}function Ce(s,i){const a=s.$$;a.fragment!==null&&(Te(a.on_destroy),a.fragment&&a.fragment.d(i),a.on_destroy=a.fragment=null,a.ctx=[])}function mr(s,i){s.$$.dirty[0]===-1&&(Ke.push(s),pr(),s.$$.dirty.fill(0)),s.$$.dirty[i/31|0]|=1<<i%31}function Ee(s,i,a,c,f,g,l,y=[-1]){const x=ot;rt(s);const b=s.$$={fragment:null,ctx:[],props:g,update:K,not_equal:f,bound:rn(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(i.context||(x?x.$$.context:[])),callbacks:rn(),dirty:y,skip_bound:!1,root:i.target||x.$$.root};l&&l(b.root);let T=!1;if(b.ctx=a?a(s,i.props||{},(C,j,...$)=>{const D=$.length?$[0]:j;return b.ctx&&f(b.ctx[C],b.ctx[C]=D)&&(!b.skip_bound&&b.bound[C]&&b.bound[C](D),T&&mr(s,C)),j}):[],b.update(),T=!0,Te(b.before_update),b.fragment=c?c(b.ctx):!1,i.target){if(i.hydrate){const C=lr(i.target);b.fragment&&b.fragment.l(C),C.forEach(te)}else b.fragment&&b.fragment.c();i.intro&&fe(s.$$.fragment),xe(s,i.target,i.anchor,i.customElement),xn()}rt(x)}class Se{$destroy(){Ce(this,1),this.$destroy=K}$on(i,a){if(!Dt(a))return K;const c=this.$$.callbacks[i]||(this.$$.callbacks[i]=[]);return c.push(a),()=>{const f=c.indexOf(a);f!==-1&&c.splice(f,1)}}$set(i){this.$$set&&!ar(i)&&(this.$$.skip_bound=!0,this.$$set(i),this.$$.skip_bound=!1)}}const Ge=[];function yt(s,i=K){let a;const c=new Set;function f(y){if(ke(s,y)&&(s=y,a)){const x=!Ge.length;for(const b of c)b[1](),Ge.push(b,s);if(x){for(let b=0;b<Ge.length;b+=2)Ge[b][0](Ge[b+1]);Ge.length=0}}}function g(y){f(y(s))}function l(y,x=K){const b=[y,x];return c.add(b),c.size===1&&(a=i(f)||K),y(s),()=>{c.delete(b),c.size===0&&(a(),a=null)}}return{set:f,update:g,subscribe:l}}var Je={exports:{}},Tn={exports:{}};/*! For license information please see jsstore.commonjs2.min.js.LICENSE.txt */(()=>{var s={d:(v,d)=>{for(var w in d)s.o(d,w)&&!s.o(v,w)&&Object.defineProperty(v,w,{enumerable:!0,get:d[w]})},o:(v,d)=>Object.prototype.hasOwnProperty.call(v,d),r:v=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(v,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(v,"__esModule",{value:!0})}},i={};s.r(i),s.d(i,{API:()=>f,CONNECTION_STATUS:()=>b,Connection:()=>le,DATA_TYPE:()=>c,ERROR_TYPE:()=>C,EVENT:()=>g,IDB_MODE:()=>y,OCCURENCE:()=>x,QUERY_OPTION:()=>l,WORKER_STATUS:()=>a,forObj:()=>F,promise:()=>$,promiseAll:()=>oe,promiseResolve:()=>D});var a,c,f,g,l,y,x,b,T=function(){function v(d,w){this.type=d,this._info=w,this.message=this.getMsg()}return v.prototype.throw=function(){throw this},v.prototype.log=function(d){this.status&&console.log(d)},v.prototype.logError=function(){console.error(this.get())},v.prototype.logWarning=function(){console.warn(this.get())},v.prototype.get=function(){return{message:this.message,type:this.type}},v.prototype.getMsg=function(){return this.type,this.message},v}(),C={InvalidUpdateColumn:"invalid_update_column",UndefinedColumn:"undefined_column",UndefinedValue:"undefined_value",UndefinedColumnName:"undefined_column_name",UndefinedDbName:"undefined_database_name",UndefinedColumnValue:"undefined_column_value",NotArray:"not_array",NoValueSupplied:"no_value_supplied",ColumnNotExist:"column_not_exist",NoIndexFound:"no_index_found",InvalidOp:"invalid_operator",NullValue:"null_value",WrongDataType:"wrong_data_type",TableNotExist:"table_not_exist",DbNotExist:"db_not_exist",ConnectionAborted:"connection_aborted",ConnectionClosed:"connection_closed",NotObject:"not_object",InvalidConfig:"invalid_config",DbBlocked:"Db_blocked",IndexedDbNotSupported:"indexeddb_not_supported",NullValueInWhere:"null_value_in_where",InvalidJoinQuery:"invalid_join_query",InvalidQuery:"invalid_query",ImportScriptsFailed:"import_scripts_failed",MethodNotExist:"method_not_exist",Unknown:"unknown",InvalidMiddleware:"invalid_middleware"};(function(v){v.Registered="registerd",v.Failed="failed",v.NotStarted="not_started"})(a||(a={})),function(v){v.String="string",v.Object="object",v.Array="array",v.Number="number",v.Boolean="boolean",v.Null="null",v.DateTime="date_time"}(c||(c={})),function(v){v.InitDb="init_db",v.Get="get",v.Set="set",v.Select="select",v.Insert="insert",v.Update="update",v.Remove="remove",v.OpenDb="open_db",v.Clear="clear",v.DropDb="drop_db",v.Count="count",v.ChangeLogStatus="change_log_status",v.Terminate="terminate",v.Transaction="transaction",v.CloseDb="close_db",v.Union="union",v.Intersect="intersect",v.ImportScripts="import_scripts",v.Middleware="middleware"}(f||(f={})),function(v){v.RequestQueueEmpty="requestQueueEmpty",v.RequestQueueFilled="requestQueueFilled",v.Upgrade="upgrade",v.Create="create",v.Open="open"}(g||(g={})),function(v){v.Where="where",v.Like="like",v.Regex="regex",v.In="in",v.Equal="=",v.Between="-",v.GreaterThan=">",v.LessThan="<",v.GreaterThanEqualTo=">=",v.LessThanEqualTo="<=",v.NotEqualTo="!=",v.Aggregate="aggregate",v.Max="max",v.Min="min",v.Avg="avg",v.Count="count",v.Sum="sum",v.List="list",v.Or="or",v.Skip="skip",v.Limit="limit",v.And="and",v.IgnoreCase="ignoreCase",v.Then="then"}(l||(l={})),function(v){v.ReadOnly="readonly",v.ReadWrite="readwrite"}(y||(y={})),function(v){v.First="f",v.Last="l",v.Any="a"}(x||(x={})),function(v){v.Connected="connected",v.Closed="closed",v.NotStarted="not_started",v.UnableToStart="unable_to_start",v.ClosedByJsStore="closed_by_jsstore"}(b||(b={}));var j,$=function(v){return new Promise(v)},D=function(v){return Promise.resolve(v)},Q=function(v,d,w){if(w||arguments.length===2)for(var O,M=0,Y=d.length;M<Y;M++)!O&&M in d||(O||(O=Array.prototype.slice.call(d,0,M)),O[M]=d[M]);return v.concat(O||Array.prototype.slice.call(d))},W=function(){function v(d){this._events={},this._ctx=d}return v.prototype.on=function(d,w){return this._events[d]==null&&(this._events[d]=[]),this._events[d].push(w),this},v.prototype.off=function(d,w){if(this._events[d])if(w){var O=this._events[d].indexOf(w);this._events[d].splice(O,1)}else this._events[d]=[]},v.prototype.emit=function(d){for(var w=this,O=[],M=1;M<arguments.length;M++)O[M-1]=arguments[M];var Y=this._events[d]||[],ie=0,S=Y.length,J=[],z=function(){var N=Y[ie++];if(N){var he=N.call.apply(N,Q([w._ctx],O,!1));return he&&he.then?he:Promise.resolve(he)}};return new Promise(function(N){var he=function(){ie<S?z().then(function(Qe){J.push(Qe),he()}):N(J)};he()})},v.prototype.destroy=function(){this._events=null,this._ctx=null},v}(),B=function(){function v(d){this.isConOpened_=!1,this.isDbIdle_=!0,this.requestQueue_=[],this.isCodeExecuting_=!1,this.inactivityTimer_=-1e3,this.middlewares=[],this.eventBus_=new W(this),this.whiteListApi_=[f.InitDb,f.OpenDb,f.Get,f.Set,f.ChangeLogStatus,f.Terminate,f.DropDb],this.isWorker=!0,this.logger=new T(null),d?(this.worker_=d,this.worker_.onmessage=this.onMessageFromWorker_.bind(this)):(this.isWorker=!1,this.initQueryManager_())}return Object.defineProperty(v.prototype,"jsstoreWorker",{get:function(){return this.$worker||self.JsStoreWorker},enumerable:!1,configurable:!0}),v.prototype.initQueryManager_=function(){var d=this.jsstoreWorker;d&&(this.queryManager=new d.QueryManager(this.processFinishedQuery_.bind(this)))},v.prototype.onMessageFromWorker_=function(d){this.processFinishedQuery_(d.data)},v.prototype.processFinishedQuery_=function(d){var w=this.requestQueue_.shift();if(w){if(this.logger.log("request ".concat(w.name," finished")),d.error)w.onError(d.error);else{switch(w.name){case f.OpenDb:case f.InitDb:this.isConOpened_=!0;break;case f.Terminate:this.isConOpened_=!1,this.isWorker===!0&&this.worker_.terminate();case f.DropDb:this.isConOpened_=!1,this.requestQueue_=[],this.isDbIdle_=!0;break;case f.CloseDb:this.requestQueue_.length>0?this.openDb_():(this.isDbIdle_=!0,this.eventBus_.emit(g.RequestQueueEmpty,[]))}w.onSuccess(d.result)}this.isCodeExecuting_=!1,this.executeQry_()}},v.prototype.openDb_=function(){this.prcoessExecutionOfQry_({name:f.OpenDb,query:{name:this.database.name,version:this.database.version},onSuccess:function(){},onError:function(d){console.error(d)}},0)},v.prototype.executeMiddleware_=function(d){var w=this;return $(function(O){var M=0,Y=w.middlewares.length-1,ie=function(){if(M<=Y){var S=w.middlewares[M++](d);S&&S.then||(S=D(S)),S.then(function(J){ie()})}else O()};ie()})},v.prototype.callResultMiddleware=function(d,w){return $(function(O){var M=0,Y=d.length-1,ie=function(){if(M<=Y){var S=d[M++](w);S.then||(S=D(S)),S.then(function(J){w=J,ie()})}else O(w)};ie()})},v.prototype.pushApi=function(d){var w=this;return new Promise(function(O,M){var Y=[];d.onResult=function(ie){Y.push(function(S){return ie(S)})},w.executeMiddleware_(d).then(function(){d.onSuccess=function(ie){w.callResultMiddleware(Y,ie).then(function(S){O(S)}).catch(function(S){d.onError(S)})},d.onError=function(ie){Y=[],M(ie)},w.requestQueue_.length===0&&(w.eventBus_.emit(g.RequestQueueFilled,[]),[f.CloseDb,f.DropDb,f.OpenDb,f.Terminate].indexOf(d.name)>=0||!w.isDbIdle_||!w.isConOpened_?clearTimeout(w.inactivityTimer_):w.openDb_()),w.prcoessExecutionOfQry_(d)}).catch(M)})},v.prototype.prcoessExecutionOfQry_=function(d,w){this.isDbIdle_=!1,w!=null?this.requestQueue_.splice(w,0,d):this.requestQueue_.push(d),this.logger.log("request pushed: "+d.name),this.executeQry_()},v.prototype.executeQry_=function(){var d=this,w=this.requestQueue_.length;if(!this.isCodeExecuting_&&w>0){if(this.isConOpened_===!0)return void this.sendRequestToWorker_(this.requestQueue_[0]);var O=this.requestQueue_.findIndex(function(M){return d.whiteListApi_.indexOf(M.name)>=0});O>=0&&(this.requestQueue_.splice(0,0,this.requestQueue_.splice(O,1)[0]),this.sendRequestToWorker_(this.requestQueue_[0]))}else w===0&&this.isDbIdle_===!1&&this.isConOpened_&&(this.inactivityTimer_=setTimeout(function(){d.prcoessExecutionOfQry_({name:f.CloseDb,onSuccess:function(){},onError:function(M){console.error(M)}})},100))},v.prototype.sendRequestToWorker_=function(d){this.isCodeExecuting_=!0,this.logger.log("request executing: "+d.name);var w={name:d.name,query:d.query};this.isWorker===!0?this.worker_.postMessage(w):this.queryManager.run(w)},v}(),H=(j=function(v,d){return j=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(w,O){w.__proto__=O}||function(w,O){for(var M in O)Object.prototype.hasOwnProperty.call(O,M)&&(w[M]=O[M])},j(v,d)},function(v,d){if(typeof d!="function"&&d!==null)throw new TypeError("Class extends value "+String(d)+" is not a constructor or null");function w(){this.constructor=v}j(v,d),v.prototype=d===null?Object.create(d):(w.prototype=d.prototype,new w)}),le=function(v){function d(w){return v.call(this,w)||this}return H(d,v),d.prototype.initDb=function(w){var O=this;return this.database=w,this.pushApi({name:f.InitDb,query:w}).then(function(M){var Y,ie=M.database;return M.isCreated&&(Y=M.oldVersion?O.eventBus_.emit(g.Upgrade,ie,M.oldVersion,M.newVersion):O.eventBus_.emit(g.Create,ie)),(Y||D()).then(function(S){return O.eventBus_.emit(g.Open,ie)}).then(function(S){return M.isCreated})})},d.prototype.dropDb=function(){return this.pushApi({name:f.DropDb})},d.prototype.select=function(w){return this.pushApi({name:f.Select,query:w})},d.prototype.count=function(w){return this.pushApi({name:f.Count,query:w})},d.prototype.insert=function(w){return this.pushApi({name:f.Insert,query:w})},d.prototype.update=function(w){return this.pushApi({name:f.Update,query:w})},d.prototype.remove=function(w){return this.pushApi({name:f.Remove,query:w})},d.prototype.clear=function(w){return this.pushApi({name:f.Clear,query:w})},Object.defineProperty(d.prototype,"logStatus",{set:function(w){this.logger.status=w,this.pushApi({name:f.ChangeLogStatus,query:w})},enumerable:!1,configurable:!0}),d.prototype.openDb=function(w,O){var M=this;return this.pushApi({name:f.OpenDb,query:{version:O,name:w}}).then(function(Y){return M.database=Y,Y})},d.prototype.getDbList=function(){return console.warn("Api getDbList is recommended to use for debugging only. Do not use in code."),indexedDB.databases()},d.prototype.get=function(w){return this.pushApi({name:f.Get,query:w})},d.prototype.set=function(w,O){return this.pushApi({name:f.Set,query:{key:w,value:O}})},d.prototype.terminate=function(){return this.pushApi({name:f.Terminate})},d.prototype.transaction=function(w){return this.pushApi({name:f.Transaction,query:w})},d.prototype.on=function(w,O){this.eventBus_.on(w,O)},d.prototype.off=function(w,O){this.eventBus_.off(w,O)},d.prototype.union=function(w){return this.pushApi({name:f.Union,query:w})},d.prototype.intersect=function(w){return this.pushApi({name:f.Intersect,query:w})},d.prototype.addPlugin=function(w,O){return w.setup(this,O)},d.prototype.addMiddleware=function(w,O){return O?this.pushApi({name:f.Middleware,query:w}):(this.middlewares.push(w),Promise.resolve())},d.prototype.importScripts=function(){for(var w=[],O=0;O<arguments.length;O++)w[O]=arguments[O];return this.pushApi({name:f.ImportScripts,query:w})},d}(B),oe=function(v){return Promise.all(v)},F=function(v,d){for(var w in v)d(w,v[w])};Tn.exports=i})();(function(s){s.exports=Tn.exports})(Je);var Ot={exports:{}};/*! For license information please see jsstore.worker.commonjs2.min.js.LICENSE.txt */var un;function yr(){return un||(un=1,(()=>{var s={d:(n,t)=>{for(var e in t)s.o(t,e)&&!s.o(n,e)&&Object.defineProperty(n,e,{enumerable:!0,get:t[e]})},o:(n,t)=>Object.prototype.hasOwnProperty.call(n,t),r:n=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})}},i={};s.r(i),s.d(i,{QueryManager:()=>tn});var a,c,f,g,l,y,x,b,T=function(n){return Promise.resolve(n)},C=function(n){return new Promise(n)},j="not_array",$="no_value_supplied",D="column_not_exist",Q="no_index_found",W="null_value",B="wrong_data_type",H="table_not_exist",le="not_object",oe="Db_blocked",F="indexeddb_not_supported",v="null_value_in_where",d="invalid_join_query",w="import_scripts_failed",O="method_not_exist",M="invalid_middleware";(function(n){n.Registered="registerd",n.Failed="failed",n.NotStarted="not_started"})(a||(a={})),function(n){n.String="string",n.Object="object",n.Array="array",n.Number="number",n.Boolean="boolean",n.Null="null",n.DateTime="date_time"}(c||(c={})),function(n){n.InitDb="init_db",n.Get="get",n.Set="set",n.Select="select",n.Insert="insert",n.Update="update",n.Remove="remove",n.OpenDb="open_db",n.Clear="clear",n.DropDb="drop_db",n.Count="count",n.ChangeLogStatus="change_log_status",n.Terminate="terminate",n.Transaction="transaction",n.CloseDb="close_db",n.Union="union",n.Intersect="intersect",n.ImportScripts="import_scripts",n.Middleware="middleware"}(f||(f={})),function(n){n.RequestQueueEmpty="requestQueueEmpty",n.RequestQueueFilled="requestQueueFilled",n.Upgrade="upgrade",n.Create="create",n.Open="open"}(g||(g={})),function(n){n.Where="where",n.Like="like",n.Regex="regex",n.In="in",n.Equal="=",n.Between="-",n.GreaterThan=">",n.LessThan="<",n.GreaterThanEqualTo=">=",n.LessThanEqualTo="<=",n.NotEqualTo="!=",n.Aggregate="aggregate",n.Max="max",n.Min="min",n.Avg="avg",n.Count="count",n.Sum="sum",n.List="list",n.Or="or",n.Skip="skip",n.Limit="limit",n.And="and",n.IgnoreCase="ignoreCase",n.Then="then"}(l||(l={})),function(n){n.ReadOnly="readonly",n.ReadWrite="readwrite"}(y||(y={})),function(n){n.First="f",n.Last="l",n.Any="a"}(x||(x={})),function(n){n.Connected="connected",n.Closed="closed",n.NotStarted="not_started",n.UnableToStart="unable_to_start",n.ClosedByJsStore="closed_by_jsstore"}(b||(b={}));var Y,ie=function(){function n(t){this.columns=[],this.autoIncColumnValue={},this.columns=this.setColumn(t.columns),this.name=t.name,this.alter=t.alter||{}}return n.prototype.setColumn=function(t){var e=[],r=function(h){var p=t[h];p.name=h,p.autoIncrement&&(o.autoIncColumnValue[h]=0),p.primaryKey&&(o.primaryKey=h),p.enableSearch=p.enableSearch==null||p.enableSearch;var m=o.columns.indexOf(function(k){return k.name===h});if(m<0)e.push(p);else{var _=o.columns[m];Object.assign(_,p)}},o=this;for(var u in t)r(u);return e},n}(),S=function(){function n(){}return n.autoIncrementKey=function(t,e){return"JsStore_".concat(t,"_").concat(e,"_Value")},n.set=function(t,e,r){r.tx||r.createTransaction([n.tableName]);var o=r.objectStore(n.tableName);return C(function(u,h){var p=o.put({key:t,value:e});p.onsuccess=function(){u()},p.onerror=h})},n.get=function(t,e){e.tx||e.createTransaction([n.tableName]);var r=e.objectStore(n.tableName);return C(function(o,u){var h=r.get(e.keyRange(t));h.onsuccess=function(){var p=h.result;o(p&&p.value)},h.onerror=u})},n.remove=function(t,e){e.tx||e.createTransaction([n.tableName]);var r=e.objectStore(n.tableName);return C(function(o,u){var h=r.delete(e.keyRange(t));h.onsuccess=o,h.onerror=u})},n.tableName="JsStore_Meta",n.dbSchema="JsStore_DbSchema",n}(),J=function(n){this.name=n.name,this.version=n.version||1,n.tables.push({name:S.tableName,columns:{key:{primaryKey:!0},value:{enableSearch:!1}}}),this.tables=n.tables.map(function(t){return new ie(t)})},z=function(n,t){for(var e in n)t(e,n[e])},N=function(){function n(t,e){this.type=t,this.info_=e,this.message=this.getMsg_()}return n.prototype.log=function(t){this.status&&console.log(t)},n.prototype.throw=function(){throw this.get()},n.prototype.logError=function(){console.error(this.get())},n.prototype.get=function(){return{message:this.message,type:this.type}},n.prototype.getMsg_=function(){var t,e,r=this.info_,o=((t={}).not_array=function(){e="Supplied value is not an array"},t.undefined_column=function(){e="Column is undefined in Where"},t.undefined_value=function(){e="Value is undefined in Where"},t.undefined_column_name=function(){e="Column name is undefined '"+r.TableName+"'"},t.undefined_database_name=function(){e="Database name is not supplied"},t.undefined_column_value=function(){e="Column value is undefined"},t.no_value_supplied=function(){e="No value is supplied"},t.invalid_operator=function(){e="Invalid Op Value '"+r.Op+"'"},t.column_not_exist=function(){var p=r.column;e=r.isOrder?"Column '".concat(p,"' in order query does not exist"):"Column '".concat(p,"' does not exist")},t.no_index_found=function(){e="No index found for column '"+r.column+"'. Query can not be executed without index."},t.null_value=function(){e="Null value is not allowed for column '"+r.ColumnName+"'"},t.wrong_data_type=function(){e="Supplied value for column '"+r.column+"' have wrong data type"},t.table_not_exist=function(){e="Table '"+r.tableName+"' does not exist"},t.db_not_exist=function(){e="Database with name ".concat(r.dbName," does not exist")},t.not_object=function(){e="supplied value is not object"},t.invalid_operator=function(){e="Invalid Config '"+r.Config+" '"},t.Db_blocked=function(){e="database is blocked, cant be deleted right now"},t.null_value_in_where=function(){e="Null/undefined is not allowed in where. Column '".concat(r.column,"' has null")},t.method_not_exist=function(){e="method '".concat(r,"' does not exist.")},t.indexeddb_not_supported=function(){e="Browser does not support indexeddb"},t.getInfo=function(){e=r},t.invalid_join_query=function(){o.getInfo()},t.import_scripts_failed=function(){o.getInfo()},t.invalid_middleware=function(){e="No function ".concat(r," is found.")},t),u=this.type,h=o[u];return h?h():(u||(this.type="unknown"),e=this.message),e},n}(),he=function(){function n(){this.logger=new N(null)}return n.prototype.emptyTx=function(){this.tx&&(this.tx.oncomplete=null,this.tx.onabort=null,this.tx.onerror=null,this.tx=null)},n.prototype.createTransactionIfNotExist=function(t,e){this.tx||this.createTransaction(t,e)},n.prototype.createTransaction=function(t,e){var r=this;return e===void 0&&(e=y.ReadWrite),this.tx=this.con.transaction(t,e),C(function(o,u){r.tx.oncomplete=o,r.tx.onabort=o,r.tx.onerror=u})},n.prototype.keyRange=function(t,e){var r;switch(e){case l.Between:r=IDBKeyRange.bound(t.low,t.high,!1,!1);break;case l.GreaterThan:r=IDBKeyRange.lowerBound(t,!0);break;case l.GreaterThanEqualTo:r=IDBKeyRange.lowerBound(t);break;case l.LessThan:r=IDBKeyRange.upperBound(t,!0);break;case l.LessThanEqualTo:r=IDBKeyRange.upperBound(t);break;default:r=IDBKeyRange.only(t)}return r},n.prototype.objectStore=function(t){return this.tx.objectStore(t)},n.prototype.abortTransaction=function(){this.tx&&this.tx.abort()},n.prototype.close=function(){var t=this;return this.con&&this.con.close(),C(function(e){t.con=null,setTimeout(e,100)})},n.prototype.initDb=function(t){var e,r=this,o=!1,u=t.version;return C(function(h,p){var m=indexedDB.open(t.name,u);m.onsuccess=function(){r.con=m.result,r.con.onversionchange=function(_){_.target.close()},h({isCreated:o,oldVersion:e,newVersion:u})},m.onerror=function(_){console.error("error",_),p(_)},m.onupgradeneeded=function(_){e=_.oldVersion;var k=_.target,E=k.result;o=!0;var q=k.transaction,L=E.objectStoreNames,A=function(Z,V){var G=V.name;if(V.enableSearch&&!Z.indexNames.contains(G)){var ce=V.primaryKey?{unique:!0}:{unique:V.unique};ce.multiEntry=V.multiEntry;var ne=V.keyPath==null?G:V.keyPath;Z.createIndex(G,ne,ce)}},I=function(Z,V,G){var ce=V.columns.findIndex(function(ne){return ne.name===G});ce>=0&&(V.columns.splice(ce,1),Z.deleteIndex(G))};t.tables.forEach(function(Z){if(!L.contains(Z.name))return function(ne){var ge=ne.primaryKey?{keyPath:ne.primaryKey}:{autoIncrement:!0},be=E.createObjectStore(ne.name,ge);ne.columns.forEach(function(nt){A(be,nt)})}(Z);for(var V=q.objectStore(Z.name),G=e+1;G<=u;G++){var ce=Z.alter[G];ce&&(ce.add&&Z.setColumn(ce.add).forEach(function(ne){A(V,ne),Z.columns.push(ne)}),z(ce.drop||{},function(ne){I(V,Z,ne)}),z(ce.modify||{},function(ne,ge){var be=ge.multiEntry||ge.keyPath||ge.unique,nt=Z.columns.find(function(xt){return xt.name===ne}),we=Object.assign(nt,ge);we.name=ne,be&&(I(V,Z,ne),A(V,we),Z.columns.push(we))}))}});for(var X=function(Z,V){var G=L.item(Z);t.tables.findIndex(function(ce){return ce.name===G})<0&&E.deleteObjectStore(G)},ve=0,Ae=L.length;ve<Ae;ve++)X(ve)}})},n}(),Qe=function(n){return Promise.all(n)},ye=function(n){return Promise.reject(n)},ut=function(n){if(n instanceof N)return n.logError(),n.get();var t=void 0;return n.name?(t=new N(n.name)).message=n.message:(t=new N(n.target.error.name)).message=n.target.error.message,t.get()},Be=function(){function n(){this.rowAffected=0,this.isTxQuery=!1,this.results=[]}return Object.defineProperty(n.prototype,"db",{get:function(){return this.util.db},enumerable:!1,configurable:!0}),n.prototype.table=function(t){var e=t||this.tableName;return this.db.tables.find(function(r){return r.name===e})},n.prototype.primaryKey=function(t){var e=this.query;return!e.from&&e.store&&e.meta?e.meta.primaryKey:this.table(t).primaryKey},n.prototype.getColumnInfo=function(t,e){return this.table(e).columns.find(function(r){return r.name===t})},n.prototype.onException=function(t,e){return console.error(t),this.util.abortTransaction(),ye(function(r,o){return o===void 0&&(o="invalid_query"),r.name=o,ut(r)}(t,e))},n}(),ue=function(n){if(n==null)return c.Null;var t=typeof n;if(t==="object"){if(Array.isArray(n))return c.Array;if(n instanceof Date)return c.DateTime}return t},Xe=function(n){return n==null||typeof n=="number"&&isNaN(n)},On=function(){function n(t,e){this.table=t,this.autoIncrementValue=e}return n.prototype.checkAndModifyValues=function(t){var e,r=this;this.query=t;var o=t.values,u=[];return o.every(function(h,p){return e=r.checkAndModifyValue(h),t.ignore&&e&&(u.push(p),e=null),!e}),u.forEach(function(h){o.splice(h,1)}),{err:e,values:o}},n.prototype.checkAndModifyValue=function(t){var e,r=this;return this.table.columns.every(function(o){return!(e=r.checkAndModifyColumnValue_(o,t))}),e},n.prototype.checkNotNullAndDataType_=function(t,e){return t.notNull&&Xe(e[t.name])?this.getError(W,{ColumnName:t.name}):t.dataType&&!Xe(e[t.name])&&ue(e[t.name])!==t.dataType?this.getError(B,{column:t.name}):void 0},n.prototype.checkAndModifyColumnValue_=function(t,e){var r=e[t.name];if(t.autoIncrement?Xe(r)?e[t.name]=++this.autoIncrementValue[t.name]:ue(r)===c.Number&&r>this.autoIncrementValue[t.name]&&(this.autoIncrementValue[t.name]=r):t.default!==void 0&&Xe(r)&&(e[t.name]=t.default),this.query.validation)return this.checkNotNullAndDataType_(t,e)},n.prototype.getError=function(t,e){return new N(t,e)},n}(),qn=function(){function n(t){this.table=t}return n.prototype.check=function(t,e){var r,o=this;return typeof t===c.Object?this.table?this.table.columns.every(function(u){return u.name in t&&(r=o.checkByColumn_(u,t[u.name])),!r}):r=new N(H,{tableName:e}):r=new N(le),r},n.prototype.checkByColumn_=function(t,e){if(t.notNull===!0&&Xe(e))return new N(W,{ColumnName:t.name});var r=ue(e),o=e!=null;if(t.dataType&&o&&r!==t.dataType&&r!=="object")return new N(B,{column:t.name});if(o&&r==="object"){var u=["+","-","*","/","{push}"];for(var h in e)if(u.indexOf(h)<0&&t.dataType&&r!==t.dataType)return new N(B,{column:t.name})}},n}(),He=function(){function n(t){this.db=t}return n.prototype.validate=function(t,e){switch(t){case f.Select:case f.Remove:case f.Count:return this.checkSelect(e);case f.Insert:return this.checkInsertQuery(e);case f.Update:return this.checkUpdate(e)}},n.prototype.getTable_=function(t){return this.db.tables.find(function(e){return e.name===t})},n.prototype.isInsertQryValid=function(t){var e,r=this.getTable_(t.into);if(r)switch(ue(t.values)){case c.Array:break;case c.Null:e=new N($);break;default:e=new N(j)}else e=new N(H,{tableName:t.into});return{table:r,log:e}},n.prototype.checkUpdate=function(t){var e=new qn(this.getTable_(t.in)).check(t.set,t.in);if(e)return e;if(t.where!=null){if(e=this.checkForNullInWhere_(t))return e;this.addGreatAndLessToNotOp_(t)}},n.prototype.checkSelect=function(t){if(!t.store&&!this.getTable_(t.from))return new N(H,{tableName:t.from});if(t.where){var e=this.checkForNullInWhere_(t);if(e)return e;this.addGreatAndLessToNotOp_(t)}},n.prototype.checkForNullInWhere_=function(t){for(var e in t.where)if(t.where[e]==null)return new N(v,{column:e})},n.prototype.addGreatAndLessToNotOp_=function(t){var e=t.where,r=function(m,_){return _.findIndex(function(k){return m[k][l.NotEqualTo]!=null})>=0},o=function(m,_){var k;return _.forEach(function(E){(k=m[E])[l.NotEqualTo]!=null&&(m[E][l.GreaterThan]=k[l.NotEqualTo],m[l.Or]===void 0?(m[l.Or]={},m[l.Or][E]={}):m[l.Or][E]===void 0&&(m[l.Or][E]={}),m[l.Or][E][l.LessThan]=k[l.NotEqualTo],delete m[E][l.NotEqualTo])}),m};if(ue(e)===c.Object){var u=Object.keys(e);if(r(e,u))if(u.length===1)t.where=o(e,u);else{var h=[];u.forEach(function(m){var _;h.push(o(((_={})[m]=e[m],_),[m]))}),t.where=h}}else{var p=[];e.forEach(function(m){var _=Object.keys(m);r(m,_)&&(m=o(m,_)),p.push(m)}),t.where=p}},n.prototype.checkInsertQuery=function(t){var e=this.isInsertQryValid(t),r=e.table,o=e.log;if(o)return o;if(!t.skipDataCheck){var u=new On(r,r.autoIncColumnValue).checkAndModifyValues(t),h=u.values,p=u.err;return t.values=h,p}},n}(),jn=(Y=function(n,t){return Y=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])},Y(n,t)},function(n,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function e(){this.constructor=n}Y(n,t),n.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}),Lt=function(n){function t(e,r){var o=n.call(this)||this;return o.valuesAffected_=[],e.validation==null&&(e.validation=!0),o.query=e,o.util=r,o.tableName=e.into,o}return jn(t,n),t.prototype.execute=function(e){var r=this,o=this.db,u=new He(o).validate(f.Insert,this.query);return u?ye(u):e().then(function(h){return r.insertData_(o).then(function(p){return r.query.return?r.valuesAffected_:r.rowAffected})}).catch(function(h){return r.util.abortTransaction(),ye(h)})},t.prototype.insertData_=function(e){var r,o,u,h=this,p=this.query;return r=p.return?function(m){h.valuesAffected_.push(m)}:function(m){++h.rowAffected},u=p.upsert?"put":"add",o=p.ignore&&!h.isTxQuery?function(m){return h.util.con.transaction(p.into,y.ReadWrite).objectStore(p.into)[u](m)}:(h.isTxQuery||h.util.createTransaction([p.into,S.tableName]),h.objectStore=h.util.objectStore(h.tableName),function(m){return h.objectStore[u](m)}),Qe(p.values.map(function(m){return C(function(_,k){var E=o(m);E.onerror=function(q){p.ignore?_():k(q)},E.onsuccess=function(){r(m),_()}})})).then(function(){S.set(S.dbSchema,e,h.util)})},t}(Be),Mt=self.alert===void 0&&typeof ServiceWorkerGlobalScope>"u",An=function(){try{if(indexedDB||(indexedDB=self.mozIndexedDB||self.webkitIndexedDB||self.msIndexedDB),!indexedDB)return!1;IDBTransaction=IDBTransaction||self.webkitIDBTransaction||self.msIDBTransaction,self.IDBKeyRange=self.IDBKeyRange||self.webkitIDBKeyRange||self.msIDBKeyRange}catch{return!1}return!0}(),$e=function(n){return Array.isArray(n)},st=function(n){return Object.keys(n)},Oe=function(n){return st(n).length},Ze=function(n){for(var t in n)return t},In=function(){function n(){}return n.prototype.setCaseAndValue=function(t,e){this.caseQuery_=t,this.setValue(e)},n.prototype.setCaseAndColumn=function(t,e){return this.caseQuery_=t,this.setColumn(e),this},n.prototype.setColumn=function(t){return this.columnName_=t,this.caseColumnQuery_=this.caseQuery_[this.columnName_],this.length_=this.caseColumnQuery_.length,this},n.prototype.setValue=function(t){return this.value=t,this},n.prototype.evaluate=function(){for(var t=0;t<this.length_;t++)if(this.checkCase_(this.caseColumnQuery_[t])===!0)return this.caseColumnQuery_[t].then;var e=this.caseColumnQuery_[this.length_-1].then;return e==null?this.value[this.columnName_]:e},n.prototype.checkCase_=function(t){var e;for(e in t){switch(e){case l.GreaterThan:if(this.value[this.columnName_]>t[e])return!0;break;case l.Equal:if(this.value[this.columnName_]===t[e])return!0;break;case l.LessThan:if(this.value[this.columnName_]<t[e])return!0;break;case l.GreaterThanEqualTo:if(this.value[this.columnName_]>=t[e])return!0;break;case l.LessThanEqualTo:if(this.value[this.columnName_]<=t[e])return!0;break;case l.NotEqualTo:if(this.value[this.columnName_]!==t[e])return!0;break;case l.Between:if(this.value[this.columnName_]>t[e].low&&this.value[this.columnName_]<t[e].high)return!0}return!1}},n}(),at=function(n,t,e,r){if(this.limitAtEnd===!1&&this.skipAtEnd===!1){if(this.skipRecord)return this.limitRecord?r:e;if(this.limitRecord)return t}return n},Dn=function(n){var t=this,e=!1;return function(r){var o=r.target.result;o?e&&t.results.length!==t.limitRecord?(t.shouldAddValue(o)&&t.pushResult(o.value),o.continue()):(e=!0,o.advance(t.skipRecord)):n()}},Nn=function(n){var t=this,e=!1;return function(r){var o=r.target.result;o?e?(t.shouldAddValue(o)&&t.pushResult(o.value),o.continue()):(e=!0,o.advance(t.skipRecord)):n()}},vt=function(n){var t=this;return function(e){var r=e.target.result;r&&t.results.length!==t.limitRecord?(t.shouldAddValue(r)&&t.pushResult(r.value),r.continue()):n()}},gt=function(n){var t=this;return function(e){var r=e.target.result;r?(t.shouldAddValue(r)&&t.pushResult(r.value),r.continue()):n()}},Rn=function(n){var t,e=this,r=!1;return function(o){(t=o.target.result)?r&&e.results.length!==e.limitRecord?(e.pushResult(t.value),t.continue()):(r=!0,t.advance(e.skipRecord)):n()}},Qn=function(n){var t,e=this,r=!1;return function(o){(t=o.target.result)?r?(e.pushResult(t.value),t.continue()):(r=!0,t.advance(e.skipRecord)):n()}},$n=function(n){var t,e=this;return function(r){(t=r.target.result)?(e.pushResult(t.value),t.continue()):n()}},Ln=function(n){var t,e=this;return function(r){(t=r.target.result)&&e.results.length!==e.limitRecord?(e.pushResult(t.value),t.continue()):n()}},Pt=function(n){return n.replace(/\s/g,"")},Bt=function(n){var t;if(!this.query.store)if(this.query.join==null)t=this.getColumnInfo(n);else{var e=Pt(n).split("."),r=e[1];t=this.getColumnInfo(r,e[0])}if(t==null){var o=this.results[0][n];if(o)return{dataType:ue(o),name:n};throw new N(D,{column:n,isOrder:!0})}return t},Wt=function(n,t){return t.localeCompare(n)},Vt=function(n,t){return n.localeCompare(t)},Mn=function(n,t){return new String(t).localeCompare(n)},Pn=function(n,t){return new String(n).localeCompare(t)},Ft=function(n,t){return t-n},Ut=function(n,t){return n-t},Bn=function(n,t){return t.getTime()-n.getTime()},Wn=function(n,t){return n.getTime()-t.getTime()},Gt=function(n,t){switch(n.dataType){case c.String:return t.type==="asc"?Vt:Wt;case c.Number:return t.type==="asc"?Ut:Ft;case c.DateTime:return t.type==="asc"?Wn:Bn;default:return t.type==="asc"?Pn:Mn}},Kt=function(n){var t;n.type=Jt(n.type);var e=n.by,r=this.thenEvaluator;if(e!=null&&typeof e===c.Object){var o=e,u=function(_,k){return function(E,q){for(var L in o){r.setCaseAndValue(o,E);var A=r.setColumn(L).evaluate();r.setCaseAndValue(o,q);var I=r.setColumn(L).evaluate();return typeof E[A]===c.String?_(E[A],q[I]):k(E[A],q[I])}}},h=n.type==="asc"?u(Vt,Ut):u(Wt,Ft);this.results.sort(h)}else{var p=Bt.call(this,e);if(p!=null){var m=Gt(p,n);e=p.name,n.case==null?this.results.sort(function(_,k){return m(_[e],k[e])}):(r.setCaseAndColumn(((t={})[e]=n.case,t),e),this.results.sort(function(_,k){return m(r.setValue(_).evaluate(),r.setValue(k).evaluate())}))}}},Jt=function(n){return n==null?"asc":n.toLowerCase()},zt=function(n){var t,e,r=n.split("%");switch(r[1]?(t=r[1],e=r.length>2?x.Any:x.Last):(t=r[0],e=x.First),e){case x.First:return new RegExp("^".concat(t),"i");case x.Last:return new RegExp("".concat(t,"$"),"i");default:return new RegExp("".concat(t),"i")}},Yt=function(n){return ue(n)==="object"&&!(n instanceof RegExp)},Xt=function(n){if(Yt(n)){var t={};for(var e in n)t[e]=n[e]!=null&&Yt(n[e])?Xt(n[e]):n[e];return t}return n},et=function(n,t,e){var r=ue(n);if(r!==ue(t))return!1;switch(r===c.DateTime&&(n=n.getTime(),t=t.getTime()),e){case l.GreaterThan:return n>t;case l.LessThan:return n<t;case l.LessThanEqualTo:return n<=t;case l.GreaterThanEqualTo:return n>=t;case l.NotEqualTo:return n!==t;default:return n===t}},_t=function(){function n(t,e){this.where=Xt(t),this.checkFlag=e}return n.prototype.remove=function(t){var e=t.pop();delete t.reduce(function(r,o){return r&&r[o]},this.where)[e]},n.prototype.check=function(t){var e=!0;if(!this.checkFlag)return e;for(var r in this.where){if(!e)return e;var o=this.where[r],u=t[r];if(ue(o)==="object")for(var h in o){if(!e)return e;switch(h){case l.In:e=this.checkIn(r,u);break;case l.Like:e=this.checkLike_(r,u);break;case l.Regex:e=this.checkRegex(r,u);break;case l.Between:case l.GreaterThan:case l.LessThan:case l.GreaterThanEqualTo:case l.LessThanEqualTo:case l.NotEqualTo:e=this.checkComparisionOp_(r,u,h);break;default:e=!1}}else e=et(o,u)}return e},n.prototype.checkIn=function(t,e){return this.where[t][l.In].find(function(r){return et(r,e)})!=null},n.prototype.checkLike_=function(t,e){return zt(this.where[t][l.Like]).test(e)},n.prototype.checkRegex=function(t,e){return this.where[t][l.Regex].test(e)},n.prototype.checkComparisionOp_=function(t,e,r){var o=this.where[t][r];return r!=l.Between?et(e,o,r):et(e,o.low,">=")&&et(e,o.high,"<=")},n}(),Vn=function(){var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,o){r.__proto__=o}||function(r,o){for(var u in o)Object.prototype.hasOwnProperty.call(o,u)&&(r[u]=o[u])},n(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}n(t,e),t.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}}(),ct=function(n){function t(){var e=n!==null&&n.apply(this,arguments)||this;return e.limitAtEnd=!1,e.skipAtEnd=!1,e}return Vn(t,n),t.prototype.goToWhereLogic=function(){var e=this,r=this.query,o=r.where,u=function(){for(var k in o)if(e.objectStore.indexNames.contains(k))return k}();if(u==null&&(u=Ze(o),!r.store))return ye(new N(Q,{column:u}));var h=o[u];if(ue(h)!=="object")return p=Oe(o)>1,this.whereChecker=new _t(o,p),this.whereChecker.remove([u]),this.executeWhereLogic(u,h,null,"next");var p=Oe(h)>1||Oe(o)>1;this.whereChecker=new _t(o,p);var m=Ze(h);switch(this.whereChecker.remove([u,m]),m){case l.Like:var _=zt(h[l.Like]);return this.executeRegexLogic(u,_);case l.Regex:return this.executeRegexLogic(u,h[l.Regex]);case l.In:return this.executeInLogic(u,h[l.In]);case l.Between:case l.GreaterThan:case l.LessThan:case l.GreaterThanEqualTo:case l.LessThanEqualTo:return this.executeWhereLogic(u,h,m,"next");case l.Aggregate:break;default:return this.executeWhereLogic(u,h,null,"next")}},t}(Be),Ht=function(n,t){var e=this;return function(r){var o=r.target.result;e.results.length!==e.limitRecord&&o?(e.shouldAddValue(o)&&t(o.value),o.continue()):n()}},Zt=function(n,t){var e=this;return function(r){var o=r.target.result;o?(e.shouldAddValue(o)&&t(o.value),o.continue()):n()}},Le=function(){return Le=Object.assign||function(n){for(var t,e=1,r=arguments.length;e<r;e++)for(var o in t=arguments[e])Object.prototype.hasOwnProperty.call(t,o)&&(n[o]=t[o]);return n},Le.apply(this,arguments)},Fn=function(){function n(t){this.joinQueryStack_=[],this.currentQueryStackIndex_=0,this.tablesFetched=[],this.results=[],this.select=t}return Object.defineProperty(n.prototype,"query",{get:function(){return this.select.query},enumerable:!1,configurable:!0}),n.prototype.getTable=function(t){return this.select.table(t)},n.prototype.executeSelect=function(t){return new ae(t,this.select.util).execute()},n.prototype.execute=function(){var t=this,e=this.query;this.joinQueryStack_=ue(e.join)===c.Object?[e.join]:e.join;var r=e.from,o=[];r&&o.push(r);for(var u=this.joinQueryStack_,h=0,p=u.length;h<p;h++){var m=u[h],_=this.getJoinTableInfo_(m.on);m.with===_.table1.table&&(_={table1:_.table2,table2:_.table1});var k=this.checkJoinQuery_(_,m);if(k)return ye(k);u[h].joinTableInfo=_,m.with&&o.push(m.with)}return!this.select.isTxQuery&&o.length>0&&this.select.util.createTransaction(o),this.executeSelect({from:r,where:e.where,case:e.case,flatten:e.flatten,store:e.store,meta:e.meta}).then(function(E){return t.results=E.map(function(q){var L;return(L={})[t.currentQueryStackIndex_]=q,L}),t.tablesFetched.push(u[0].joinTableInfo.table1.table),t.startExecutingJoinLogic_()})},n.prototype.onJoinQueryFinished_=function(){if(this.results.length!==0){var t=this.select;try{var e=[],r=st(this.results[0]).length;this.results.forEach(function(o){for(var u=o[0],h=1;h<r;h++)u=Le(Le({},u),o[h]);e.push(u)}),t.results=e,t.setLimitAndSkipEvaluationAtEnd_(),t.query.flatten=null,t.processOrderBy()}catch(o){return ye(new N(d,o.message))}}},n.prototype.startExecutingJoinLogic_=function(){var t=this,e=this.joinQueryStack_[this.currentQueryStackIndex_];if(!e)return this.onJoinQueryFinished_();try{var r=e.joinTableInfo;return this.executeSelect({from:e.with,where:e.where,case:e.case,flatten:e.flatten,store:e.store,meta:e.meta}).then(function(o){return t.jointables(e,r,o),t.tablesFetched.push(r.table2.table),++t.currentQueryStackIndex_,t.startExecutingJoinLogic_()})}catch(o){return ye(new N(d,o.message))}},n.prototype.jointables=function(t,e,r){var o,u=this,h=t.type,p=[],m=e.table1.column,_=e.table2.column,k=this.tablesFetched.indexOf(e.table1.table),E=this.currentQueryStackIndex_+1,q=t.as,L=q?function(A){for(var I in q){var X=q[I];A[X]===void 0&&(A[X]=A[I],delete A[I])}return A}:function(A){return A};h==="left"?function(){var A,I,X=0,ve={};t.store?st(t.store).forEach(function(V){ve[V]=null}):u.getTable(e.table2.table).columns.forEach(function(V){ve[V.name]=null}),I=E===1?function(V,G){G[k][m]===V[_]&&A.push(V)}:function(V,G){var ce=G[k];ce!=null&&ce[m]===V[_]&&A.push(V)};var Ae=Object.assign(t.where||{},t.whereJoin||{}),Z=new _t(Ae,Oe(Ae)>0);u.results.forEach(function(V){A=[],r.forEach(function(G){I(G,V)}),A.length===0&&(A=[ve]),A.forEach(function(G){G=L(G),Z.check(G)&&(p[X]=Le({},V),p[X++][E]=G)})})}():(o=0,u.results.forEach(function(A){r.forEach(function(I){A[k][m]===I[_]&&(p[o]=Le({},A),p[o++][E]=L(Le({},I)))})})),this.results=p},n.prototype.getJoinTableInfo_=function(t){var e=(t=Pt(t)).split("="),r=e[0].split("."),o=e[1].split(".");return{table1:{table:r[0],column:r[1]},table2:{table:o[0],column:o[1]}}},n.prototype.checkJoinQuery_=function(t,e){if(e.store)return null;var r,o=t.table1,u=t.table2,h=this.getTable(o.table),p=this.getTable(u.table);e.with!==u.table&&(r=new N(d,"on value should contains value of with")),h.columns.find(function(q){return q.name===o.column})==null?r=new N(d,"column ".concat(o.column," does not exist in table ").concat(o.table)):p.columns.find(function(q){return q.name===u.column})==null&&(r=new N(d,"column ".concat(u.column," does not exist in table ").concat(u.table))),e.as==null&&(e.as={}),h.columns.every(function(q){var L=p.columns.find(function(A){return A.name===q.name&&A.name!==o.column});return L==null||e.as[L.name]!=null||(r=new N(d,"column ".concat(q.name," exist in both table ").concat(o.table," & ").concat(u.table)),!1)});var m=e.where;if(m){var _={},k=function(q){p.columns.find(function(L){return L.name===q})||(_[q]=m[q],delete m[q])};for(var E in m)k(E);e.whereJoin=_,Oe(m)===0&&(e.where=null)}return r},n}(),Un=function(){function n(t){this.data=t}return Object.defineProperty(n.prototype,"indexNames",{get:function(){var t=st(this.data[0]);return{contains:function(e){return t.indexOf(e)>=0}}},enumerable:!1,configurable:!0}),n.prototype.index=function(t){var e=this;return{openCursor:function(r){var o={},u=0,h={continue:function(){++u,m()}},p=function(_){o.onsuccess({target:{result:_}})},m=function(){var _=e.data[u];if(_){var k=_[t];k&&(r==null||r.includes(k))?(h.key=k,h.value=_,p(h)):h.continue()}else p(null)};return T().then(m),o}}},n}(),Gn=function(){var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,o){r.__proto__=o}||function(r,o){for(var u in o)Object.prototype.hasOwnProperty.call(o,u)&&(r[u]=o[u])},n(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}n(t,e),t.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}}(),lt=function(){return lt=Object.assign||function(n){for(var t,e=1,r=arguments.length;e<r;e++)for(var o in t=arguments[e])Object.prototype.hasOwnProperty.call(t,o)&&(n[o]=t[o]);return n},lt.apply(this,arguments)},ft=function(n,t,e){if(e||arguments.length===2)for(var r,o=0,u=t.length;o<u;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return n.concat(r||Array.prototype.slice.call(t))},ae=function(n){function t(e,r){var o=n.call(this)||this;o.sorted=!1,o.isSubQuery=!1,o.thenEvaluator=new In,o.returnResult_=function(){if(o.results.length>0){var h=o.query;if(h.flatten){var p=[],m=new Map;h.flatten.forEach(function(k){o.results.forEach(function(E,q){E[k].forEach(function(L){var A;p.push(lt(lt({},E),((A={})[k]=L,A)))}),m.set(q,!0)})});var _=0;m.forEach(function(k,E){o.results.splice(E-_,1),++_}),o.results=o.results.concat(p)}o.processGroupDistinctAggr(),o.processOrderBy(),o.skipAtEnd&&o.results.splice(0,h.skip),o.limitAtEnd&&(o.results=o.results.slice(0,h.limit))}return o.results},o.query=e,o.util=r,o.tableName=e.from,o.setPushResult(),$e(e.where)?(o.isArrayQry=!0,o.setLimitAndSkipEvaluationAtEnd_()):(o.skipRecord=e.skip,o.limitRecord=e.limit);var u=e.order;return u?(($e(u)||u.case||typeof u.by=="object")&&(u.idbSorting=!1),o.setLimitAndSkipEvaluationAtEnd_()):e.groupBy&&o.setLimitAndSkipEvaluationAtEnd_(),o}return Gn(t,n),t.prototype.execute=function(e){var r=this;e||(e=function(){return T(null)});var o=this.query;try{var u=new He(this.db).validate(f.Select,o);return u?ye(u):e().then(function(h){return r.initTransaction_(),(o.join==null?o.where!=null?$e(o.where)?r.processWhereArrayQry():r.processWhere_():r.executeWhereUndefinedLogic():r.executeJoinQuery()).then(r.returnResult_.bind(r))})}catch(h){return this.onException(h)}},t.prototype.processWhereArrayQry=function(){var e=this;this.isArrayQry=!0;var r,o=this.query.where,u=this.primaryKey(),h=!0,p=[],m=function(){var k;if(r===l.And?h===!0?p=e.results:p.length>0&&(k=[],e.results.forEach(function(E){var q;q=E[u],p.findIndex(function(L){return L[u]===q})>=0&&k.push(E)}),p=k,k=null):(p.length>0&&(e.results=ft(ft([],p,!0),e.results,!0),e.removeDuplicates()),p=e.results),h=!1,o.length>0)return e.results=[],_();e.results=p},_=function(){var k=o.shift();return k[l.Or]&&Oe(k)===1?(r=l.Or,k=k[l.Or]):r=l.And,e.query.where=k,e.processWhere_().then(m)};return _()},t.prototype.initTransaction_=function(){var e=this.query.store;e?this.objectStore=new Un(e):(this.isTxQuery||this.util.createTransactionIfNotExist([this.tableName],y.ReadOnly),this.objectStore=this.util.objectStore(this.tableName))},t.prototype.processWhere_=function(){var e=this;return this.shouldAddValue=function(r){return e.whereChecker.check(r.value)},this.query.where.or&&this.processOrLogic_(),this.goToWhereLogic().then(function(){return e.onWhereEvaluated()})},t.prototype.onWhereEvaluated=function(){if(this.isOr)return this.orQuerySuccess_()},t.prototype.orQueryFinish_=function(){this.isOr=!1,this.results=this.orInfo.results,this.orInfo=null,this.removeDuplicates()},t.prototype.orQuerySuccess_=function(){var e=this.query;this.results.length>0&&(this.orInfo.results=ft(ft([],this.orInfo.results,!0),this.results,!0)),this.results=[];var r=Ze(this.orInfo.orQuery);if(r!=null){var o={};return o[r]=this.orInfo.orQuery[r],delete this.orInfo.orQuery[r],e.where=o,this.goToWhereLogic().then(this.onWhereEvaluated.bind(this))}return this.orQueryFinish_()},t.prototype.processOrLogic_=function(){this.isOr=!0;var e=this.query.where;this.orInfo={orQuery:e.or,results:[]},this.setLimitAndSkipEvaluationAtEnd_(),delete e.or},t}(ct);ae.prototype.executeInLogic=function(n,t){var e=this,r=this.skipRecord,o=function(h){r===0?e.pushResult(h):--r},u=at.call(this,gt,vt,Zt,Ht);return Qe(t.map(function(h){return C(function(p,m){var _=e.objectStore.index(n).openCursor(e.util.keyRange(h));_.onsuccess=u.call(e,p,o),_.onerror=m})}))},ae.prototype.executeWhereUndefinedLogic=function(){var n,t=this,e=this.query,r=e.store;if(r)return this.results=r,this.setLimitAndSkipEvaluationAtEnd_(),T();var o=e.order,u=this.objectStore;if(o&&o.idbSorting!==!1&&o.by){if(!u.indexNames.contains(o.by))return ye(new N(D,{column:o.by,isOrder:!0}));var h=o.type&&o.type.toLowerCase()==="desc"?"prev":"next";this.sorted=!0,n=u.index(o.by).openCursor(null,h)}else n=u.openCursor();var p=at.call(this,$n,Ln,Qn,Rn);return C(function(m,_){n.onerror=_,n.onsuccess=p.call(t,m)})},ae.prototype.executeWhereLogic=function(n,t,e,r){var o=this;t=e?t[e]:t;var u=this.objectStore.index(n).openCursor(this.util.keyRange(t,e),r),h=at.call(this,gt,vt,Nn,Dn);return C(function(p,m){u.onerror=m,u.onsuccess=h.call(o,p)})},ae.prototype.executeRegexLogic=function(n,t){var e=this,r=this.skipRecord,o=function(p){r===0?e.pushResult(p):--r};this.shouldAddValue=function(p){return t.test(p.key)&&e.whereChecker.check(p.value)};var u=this.objectStore.index(n).openCursor(),h=at.call(this,gt,vt,Zt,Ht);return C(function(p,m){u.onerror=m,u.onsuccess=h.call(e,p,o)})},ae.prototype.setLimitAndSkipEvaluationAtEnd_=function(){this.query.limit&&(this.limitAtEnd=!0),this.query.skip&&(this.skipAtEnd=!0)},ae.prototype.setPushResult=function(){var n=this,t=this.query.case;this.pushResult=t?function(e){var r;for(r in n.thenEvaluator.setCaseAndValue(t,e),t)e[r]=n.thenEvaluator.setColumn(r).evaluate();n.results.push(e)}:function(e){n.results.push(e)}},ae.prototype.removeDuplicates=function(){for(var n=this.results,t=this.primaryKey(),e=new Map,r=0,o=n.length;r<o;r++)e.set(n[r][t],n[r]);this.results=Array.from(e.values())},ae.prototype.executeJoinQuery=function(){return new Fn(this).execute()},ae.prototype.processGroupDistinctAggr=function(){var n=this.query;if(n.distinct){var t=[],e=this.results[0];for(var r in e)t.push(r);var o=this.primaryKey(),u=t.indexOf(o);t.splice(u,1),n.groupBy=t.length>0?t:null}n.groupBy?n.aggregate?this.executeAggregateGroupBy():this.processGroupBy():n.aggregate&&this.processAggregateQry()},ae.prototype.processOrderBy=function(){var n=this.query.order;if(n&&this.results.length>0&&!this.sorted){var t=ue(n);if(t===c.Object)Kt.call(this,n);else if(t===c.Array){Kt.call(this,n[0]);for(var e=function(h,p){var m=n[h-1].by,_=n[h],k=_.by,E=Bt.call(r,k);if(E!=null){k=E.name,_.type=Jt(_.type);var q=Gt(E,_);r.results.sort(function(L,A){return L[m]===A[m]?q(L[k],A[k]):0})}},r=this,o=1,u=n.length;o<u;o++)e(o)}}},ae.prototype.processAggregateQry=function(){var n,t=this.results,e=t.length,r={},o=function(){var I=0;for(var X in t)I+=t[X][n]?1:0;return I},u=function(){var I=0;for(var X in t)I=I>t[X][n]?I:t[X][n];return I},h=function(){var I=1/0,X=1/0;for(var ve in t)I=I<(X=t[ve][n]?t[ve][n]:1/0)?I:X;return I},p=function(){var I=0;for(var X in t)I+=t[X][n];return I},m=function(){return p()/e},_=this.query.aggregate;for(var k in _){var E=_[k],q=ue(E),L=void 0;switch(k){case"count":L=o;break;case"max":L=u;break;case"min":L=h;break;case"sum":L=p;break;case"avg":L=m}switch(q){case c.String:n=E,r["".concat(k,"(").concat(n,")")]=L();break;case c.Array:for(var A in E)n=E[A],r["".concat(k,"(").concat(n,")")]=L()}}for(var k in r)t[0][k]=r[k];this.results=[t[0]]},ae.prototype.executeAggregateGroupBy=function(){var n,t,e,r,o=this.query.groupBy,u=this.results,h=new Map,p=this.query.aggregate,m=function(){var Ae=function(){return e=(e=h.get(t))?e["count("+r+")"]:0,e+=u[n][r]?1:0},Z=function(){return(e=(e=h.get(t))?e["list("+r+")"]:[]).push(u[n][r]),e},V=function(){return e=(e=h.get(t))?e["max("+r+")"]:0,u[n][r]=u[n][r]?u[n][r]:0,e>u[n][r]?e:u[n][r]},G=function(){return e=(e=h.get(t))?e["min("+r+")"]:1/0,u[n][r]=u[n][r]?u[n][r]:1/0,e<u[n][r]?e:u[n][r]},ce=function(){return e=(e=h.get(t))?e["sum("+r+")"]:0,e+=u[n][r]?u[n][r]:0},ne=function(){var nn=(e=h.get(t))?e["sum("+r+")"]:0;nn+=u[n][r]?u[n][r]:0,u[n]["sum("+r+")"]=nn,e=e?e["count("+r+")"]:0,e+=u[n][r]?1:0,u[n]["count("+r+")"]=e};for(var ge in p){var be=p[ge],nt=ue(be),we=void 0;switch(ge){case l.Count:we=Ae;break;case l.Max:we=V;break;case l.Min:we=G;break;case l.Sum:we=ce;break;case l.Avg:we=ne;break;case l.List:we=Z}switch(nt){case c.String:r=be,u[n]["".concat(ge,"(").concat(r,")")]=we();break;case c.Array:for(var xt in be)r=be[xt],u[n]["".concat(ge,"(").concat(r,")")]=we()}}};if(ue(o)===c.String)for(n in u)t=u[n][o],m(),h.set(t,u[n]);else for(n in u){for(var _ in t="",o)t+=u[n][o[_]];m(),h.set(t,u[n])}u=Array.from(h.values());var k=p.avg;if(k)if(ue(k)===c.String)for(n in u){var E=u[n]["sum("+k+")"],q=u[n]["count("+k+")"];u[n]["avg("+k+")"]=E/q,p.count!==k&&delete u[n]["count("+k+")"],p.sum!==k&&delete u[n]["sum("+k+")"]}else{var L=ue(p.count)===c.String,A=ue(p.sum)===c.String;for(n in u)for(var _ in k){var I=k[_],X=u[n]["sum("+I+")"],ve=u[n]["count("+I+")"];u[n]["avg("+I+")"]=X/ve,L&&(p.count!==I||p.count.indexOf(I)===-1)&&delete u[n]["count("+I+")"],A&&(p.sum!==I||p.sum.indexOf(I)===-1)&&delete u[n]["sum("+I+")"]}}this.results=u},ae.prototype.processGroupBy=function(){var n=this.query.groupBy,t=this.results,e=new Map,r=ue(n);if(r!==c.Object)if(r===c.String)for(var o in t)e.set(t[o][n],t[o]);else{var u=void 0;for(var o in t){for(var h in u="",n)u+=t[o][n[h]];e.set(u,t[o])}}else if(Object.keys(n).length===1){var p=Ze(n);for(var o in this.thenEvaluator.setCaseAndColumn(n,p),t)e.set(this.thenEvaluator.setValue(t[o]).evaluate(),t[o])}else for(var o in u=void 0,t){for(var h in u="",this.thenEvaluator.setCaseAndValue(n,t[o]),n)u+=this.thenEvaluator.setColumn(h).evaluate();e.set(u,t[o])}this.results=Array.from(e.values())};var bt=function(n){var t=this;return function(e){var r=e.target.result;r?(t.shouldAddValue(r)&&++t.resultCount,r.continue()):n()}},Kn=function(){var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,o){r.__proto__=o}||function(r,o){for(var u in o)Object.prototype.hasOwnProperty.call(o,u)&&(r[u]=o[u])},n(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}n(t,e),t.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}}(),We=function(n){function t(e,r){var o=n.call(this)||this;return o.resultCount=0,o.query=e,o.util=r,o.tableName=e.from,o}return Kn(t,n),t.prototype.execute=function(e){var r=this,o=new He(this.db),u=this.query,h=o.validate(f.Count,u);return h?ye(h):e().then(function(p){var m;try{var _=function(){var k=new ae(u,r.util);return k.isTxQuery=r.isTxQuery,k.execute().then(function(E){r.resultCount=E.length})};r.initTransaction_(),u.join==null?u.where!=null?u.where.or||$e(u.where)?m=_():(r.shouldAddValue=function(k){return r.whereChecker.check(k.value)},m=r.goToWhereLogic()):m=r.executeWhereUndefinedLogic():m=_()}catch(k){r.onException(k)}return m.then(function(k){return r.resultCount})})},t.prototype.initTransaction_=function(){var e=this.query.from;this.isTxQuery||this.util.createTransaction([e],y.ReadOnly),this.objectStore=this.util.objectStore(e)},t}(ct);We.prototype.executeWhereUndefinedLogic=function(){var n,t,e=this,r=this.objectStore,o=r.count?(n=r.count(),function(u){return function(){e.resultCount=n.result,u()}}):(n=r.openCursor(),function(u){return function(h){(t=h.target.result)?(++e.resultCount,t.continue()):u()}});return C(function(u,h){n.onerror=h,n.onsuccess=o(u)})},We.prototype.executeWhereLogic=function(n,t,e){var r,o=this;t=e?t[e]:t;var u=Oe(this.query.where)===1,h=this.objectStore;return C(function(p,m){u&&h.count?(r=h.index(n).count(o.util.keyRange(t,e))).onsuccess=function(){o.resultCount=r.result,p()}:(r=h.index(n).openCursor(o.util.keyRange(t,e))).onsuccess=bt.call(o,p),r.onerror=m})},We.prototype.executeRegexLogic=function(n,t){var e=this,r=this.objectStore.index(n).openCursor();return this.shouldAddValue=function(o){return t.test(o.key)&&e.whereChecker.check(o.value)},C(function(o,u){r.onerror=u,r.onsuccess=bt.call(e,o)})},We.prototype.executeInLogic=function(n,t){var e=this,r=this.objectStore,o=r.index(n),u=Oe(this.query.where)===1;return Qe(t.map(function(h){return p=h,m=e.util.keyRange(p),u&&r.count?C(function(_,k){var E=o.count(m);E.onsuccess=function(q){e.resultCount+=q.target.result,_()},E.onerror=k}):C(function(_,k){var E=o.openCursor(m);E.onsuccess=bt.call(e,_),E.onerror=k});var p,m}))};var tt=function(n){return($e(n)?n:n.split(".")).reduce(function(t,e){return t&&t[e]},self)},ht=function(n,t){var e=n.set,r=n.mapSet;if(r){var o=r(e,t);o!=null&&(e=o)}for(var u in e){var h=e[u];if(ue(h)!==c.Object)t[u]=h;else for(var p in h){var m=h[p];switch(p){case"+":t[u]+=m;break;case"-":t[u]-=m;break;case"*":t[u]*=m;break;case"/":t[u]/=m;break;case"{push}":t[u].push(m);break;default:t[u]=h}break}}return t},Jn=function(){var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,o){r.__proto__=o}||function(r,o){for(var u in o)Object.prototype.hasOwnProperty.call(o,u)&&(r[u]=o[u])},n(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}n(t,e),t.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}}(),Ve=function(n){function t(e,r){var o=n.call(this)||this;o.query=e,o.util=r,o.tableName=e.in;var u=e.mapSet;if(u){var h=ue(u)===c.String?tt(u):u;if(!h)throw new N(O,u);e.mapSet=h}return o}return Jn(t,n),t.prototype.execute=function(e){var r=this,o=this.query;try{var u=new He(this.db).validate(f.Update,o);return u?ye(u):e().then(function(h){return r.initTransaction(),(o.where!=null?o.where.or||$e(o.where)?r.executeComplexLogic_():r.goToWhereLogic():r.executeWhereUndefinedLogic()).then(function(){return r.rowAffected})})}catch(h){return this.onException(h)}},t.prototype.executeComplexLogic_=function(){var e=this,r=this.query,o=new ae({from:r.in,where:r.where,ignoreCase:r.ignoreCase},this.util);return o.isTxQuery=this.isTxQuery,o.execute().then(function(u){var h,p,m=e.primaryKey(r.in),_=[];u.forEach(function(E){_.push(E[m])}),u=null;var k=((h={})[m]=((p={})[l.In]=_,p),h);return e.query.where=k,e.initTransaction(),e.goToWhereLogic()})},t.prototype.initTransaction=function(){var e=this.query.in;this.isTxQuery||this.util.createTransaction([e]),this.objectStore=this.util.objectStore(e)},t}(ct);Ve.prototype.executeWhereUndefinedLogic=function(){var n=this,t=this.objectStore.openCursor();return C(function(e,r){t.onsuccess=function(o){var u=o.target.result;if(u)try{var h=u.update(ht(n.query,u.value));h.onsuccess=function(){++n.rowAffected,u.continue()},h.onerror=r}catch(p){r(p)}else e()},t.onerror=r})},Ve.prototype.executeWhereLogic=function(n,t,e){var r=this,o=this.query;t=e?t[e]:t;var u=this.objectStore.index(n).openCursor(this.util.keyRange(t,e));return C(function(h,p){u.onsuccess=function(m){var _=m.target.result;if(_)if(r.whereChecker.check(_.value))try{var k=_.update(ht(o,_.value));k.onsuccess=function(){++r.rowAffected,_.continue()},k.onerror=p}catch(E){p(E)}else _.continue();else h()},u.onerror=p})},Ve.prototype.executeRegexLogic=function(n,t){var e,r=this,o=this.objectStore.index(n).openCursor();return this.shouldAddValue=function(u){return t.test(u.key)&&r.whereChecker.check(u.value)},C(function(u,h){o.onsuccess=function(p){if(e=p.target.result)if(r.shouldAddValue(e))try{var m=e.update(ht(r.query,e.value));m.onsuccess=function(){++r.rowAffected,e.continue()},m.onerror=h}catch(_){h(_)}else e.continue();else u()},o.onerror=h})},Ve.prototype.executeInLogic=function(n,t){var e=this,r=this.objectStore.index(n),o=this.query;return Qe(t.map(function(u){return h=u,C(function(p,m){var _=r.openCursor(e.util.keyRange(h));_.onsuccess=function(k){var E=k.target.result;if(E){var q=E.value;if(e.whereChecker.check(q))try{var L=E.update(ht(o,q));L.onsuccess=function(){++e.rowAffected,E.continue()},L.onerror=m}catch(A){m(A)}else E.continue()}else p()},_.onerror=m});var h}))};var zn=function(){var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,o){r.__proto__=o}||function(r,o){for(var u in o)Object.prototype.hasOwnProperty.call(o,u)&&(r[u]=o[u])},n(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}n(t,e),t.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}}(),wt=function(){return wt=Object.assign||function(n){for(var t,e=1,r=arguments.length;e<r;e++)for(var o in t=arguments[e])Object.prototype.hasOwnProperty.call(t,o)&&(n[o]=t[o]);return n},wt.apply(this,arguments)},Yn=function(n){function t(e,r){var o=n.call(this)||this;return o.query=e,o.util=r,o}return zn(t,n),t.prototype.execute=function(){var e,r,o=this,u=this.query,h=0,p={},m={},_=!0,k=u.queries,E=k.length;if(k.every(function(A,I){return!(I+1<E&&A.from!==k[I+1].from&&(_=!1,1))}),_){var q=this.primaryKey(k[0].from);e=function(A){return A[q]}}else e=function(A){var I="";for(var X in A)I+=A[X];return I};var L=function(){if(h<E)return(r=new ae(k[h],o.util)).execute().then(function(ne){return p={},ne.forEach(function(ge){var be=e(ge);h===0?m[be]=ge:m[be]!=null&&(p[be]=ge)}),h>0&&(m=wt({},p)),++h,L()});var A,I=[],X=void 0,ve=u.skip,Ae=u.limit,Z=!1,V=function(){I.push(p[A])},G=function(){I.length<Ae?V():Z=!0},ce=function(ne){ve===0?ne():--ve};if(X=u.skip&&u.limit?function(){ce(function(){G()})}:u.limit?G:u.skip?function(){ce(function(){V()})}:function(){V()},Ae){for(A in p)if(X(A),Z)break}else for(A in p)X(A);return r.results=I,Object.assign(r.query,{order:u.order,join:{}}),r.processOrderBy(),r.processGroupDistinctAggr(),r.results};return L()},t}(Be),Xn=function(){function n(){}return n.prototype.execute=function(t){return C(function(e,r){var o=indexedDB.deleteDatabase(t);o.onblocked=function(){var u=new N(oe);return r(ut(u))},o.onerror=function(u){return r(ut(u))},o.onsuccess=function(){e()}})},n}(),Hn=function(){var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,o){r.__proto__=o}||function(r,o){for(var u in o)Object.prototype.hasOwnProperty.call(o,u)&&(r[u]=o[u])},n(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}n(t,e),t.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}}(),Zn=function(n){function t(e,r){var o=n.call(this)||this;return o.query=e,o.util=r,o}return Hn(t,n),t.prototype.execute=function(){var e,r=this,o=this.query,u=0,h=new Map,p=!0,m=o.length;if(o.every(function(E,q){return!(q+1<m&&E.from!==o[q+1].from&&(p=!1,1))}),p){var _=this.primaryKey(o[0].from);e=function(E){return E[_]}}else e=function(E){var q="";for(var L in E)q+=E[L];return q};var k=function(){return u<o.length?new ae(o[u++],r.util).execute().then(function(E){return E.forEach(function(q){h.set(e(q),q)}),k()}):Array.from(h.values())};return k()},t}(Be),en=function(n){var t=this;return function(e){var r=e.target.result;r?(t.shouldAddValue(r.value)&&(r.delete(),++t.rowAffected),r.continue()):n()}},er=function(){var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,o){r.__proto__=o}||function(r,o){for(var u in o)Object.prototype.hasOwnProperty.call(o,u)&&(r[u]=o[u])},n(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}n(t,e),t.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}}(),Fe=function(n){function t(e,r){var o=n.call(this)||this;return o.query=e,o.util=r,o.tableName=e.from,o}return er(t,n),t.prototype.execute=function(e){var r,o=this,u=new He(this.db),h=this.query,p=u.validate(f.Remove,h);return p?ye(p):e().then(function(m){try{o.initTransaction_(),r=h.where!=null?$e(h.where)?o.processWhereArrayQry():o.processWhere_():o.executeWhereUndefinedLogic()}catch(_){return o.onException(_)}return r.then(function(){return o.rowAffected})})},t.prototype.processWhereArrayQry=function(){var e=this,r=new ae(this.query,this.util);return r.isTxQuery=this.isTxQuery,r.execute().then(function(o){var u,h,p=[],m=e.primaryKey(e.query.from);o.forEach(function(k){p.push(k[m])}),o=null;var _=((u={})[m]=((h={})[l.In]=p,h),u);return e.query[l.Where]=_,e.processWhere_()})},t.prototype.processWhere_=function(){var e=this;return this.shouldAddValue=function(r){return e.whereChecker.check(r)},this.query.where.or&&this.processOrLogic(),this.goToWhereLogic().then(function(){return e.onWhereEvaluated()})},t.prototype.initTransaction_=function(){this.isTxQuery||this.util.createTransaction([this.query.from]),this.objectStore=this.util.objectStore(this.query.from)},t.prototype.onWhereEvaluated=function(){if(this.isOr)return this.orQuerySuccess_()},t.prototype.orQuerySuccess_=function(){var e=this,r=this._orInfo.OrQuery,o=Ze(r);if(o!=null){var u={};return u[o]=r[o],delete r[o],this.query.where=u,this.goToWhereLogic().then(function(){return e.onWhereEvaluated()})}this.isOr=!0},t.prototype.processOrLogic=function(){this.isOr=!0;var e=this.query.where;this._orInfo={OrQuery:e.or},delete e.or},t}(ct);Fe.prototype.executeInLogic=function(n,t){var e=this,r=this.objectStore.index(n);return Qe(t.map(function(o){return u=o,C(function(h,p){var m=r.openCursor(e.util.keyRange(u));m.onsuccess=en.call(e,h),m.onerror=p});var u}))},Fe.prototype.executeWhereUndefinedLogic=function(){var n,t=this,e=this.objectStore.openCursor();return C(function(r,o){e.onsuccess=function(u){(n=u.target.result)?(n.delete(),++t.rowAffected,n.continue()):r()},e.onerror=o})},Fe.prototype.executeWhereLogic=function(n,t,e){var r=this;t=e?t[e]:t;var o=this.objectStore.index(n).openCursor(this.util.keyRange(t,e));return C(function(u,h){o.onsuccess=en.call(r,u),o.onerror=h})},Fe.prototype.executeRegexLogic=function(n,t){var e,r=this,o=this.objectStore.index(n).openCursor();return this.shouldAddValue=function(u){return t.test(u.key)&&r.whereChecker.check(u.value)},C(function(u,h){o.onsuccess=function(p){(e=p.target.result)?(r.shouldAddValue(e)&&(e.delete(),++r.rowAffected),e.continue()):u()},o.onerror=h})};var tr=function(){var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,o){r.__proto__=o}||function(r,o){for(var u in o)Object.prototype.hasOwnProperty.call(o,u)&&(r[u]=o[u])},n(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}n(t,e),t.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}}(),nr=function(n){function t(e,r){var o=n.call(this)||this;return o.query=e,o.util=r,o.tableName=e,o}return tr(t,n),t.prototype.execute=function(e){var r=this,o=this.query;return this.isTxQuery||this.util.createTransaction([o,S.tableName]),e().then(function(u){var h=r.util.objectStore(o).clear();try{return C(function(p,m){h.onsuccess=function(_){var k=r.table(o);for(var E in k.autoIncColumnValue)k.autoIncColumnValue[E]=0;S.set(S.dbSchema,r.util.db,r.util).then(p).catch(m)},h.onerror=m})}catch(p){return r.onException(p)}})},t}(Be),rr=function(){var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,o){r.__proto__=o}||function(r,o){for(var u in o)Object.prototype.hasOwnProperty.call(o,u)&&(r[u]=o[u])},n(t,e)};return function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}n(t,e),t.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}}(),or=function(n){function t(e,r){var o=n.call(this)||this;return o.results={},o.reqQueue=[],o.isQueryExecuting=!1,o.isTxStarted_=!1,o.query=e,o.util=r,o}return rr(t,n),t.prototype.execute=function(e){var r=this;this.beforeExecute=e;var o=this.validate();return o?ye(o):(this.startExecution_(),C(function(u,h){r.onSuccess=u,r.onError=h}).then(function(u){return r.beforeExecute=null,r.log("transaction finished"),u}))},t.prototype.validate=function(){var e=this.query,r=this.notExistingTable_(e.tables);if(r)return new N(H,{tableName:r});var o=e.method;return tt(o)?void 0:new N(O,o)},t.prototype.startExecution_=function(){var e=this,r=this.query,o=function(p){return function(m){return e.pushReq_({name:p,query:m})}},u=r.method,h=tt(u);return this.log("transaction query started"),h.call(this,{data:r.data,insert:o(f.Insert),select:o(f.Select),update:o(f.Update),remove:o(f.Remove),count:o(f.Count),setResult:function(p,m){e.results[p]=m},getResult:function(p){return e.results[p]},abort:function(p){e.abortTx_(p)},start:function(){e.startTx_()}})},t.prototype.log=function(e){this.util.logger.log(e)},t.prototype.startTx_=function(){var e=this;try{this.isTxStarted_=!0;var r=this.query.tables;return r=r.concat(S.tableName),this.util.createTransaction(r).then(function(o){e.onSuccess(e.results)}).catch(function(o){e.onError(o)}),this.processExecutionOfQry_()}catch(o){this.onError(this.onException(o))}},t.prototype.onReqFinished_=function(e){var r=this.reqQueue.shift();this.log("finished request : ".concat(r.name," ")),r&&(e.error?(this.abortTx_("automatic abort of transaction due to error occured"),this.log("transaction aborted due to error occured"),this.onError(e.error)):(this.isQueryExecuting=!1,r.onSuccess&&r.onSuccess(e),this.processExecutionOfQry_()))},t.prototype.abortTx_=function(e){this.reqQueue=[],this.util.abortTransaction(),this.log("transaction aborted. Msg : ".concat(e))},t.prototype.executeRequest_=function(e){var r,o=this;this.isQueryExecuting=!0,this.log("executing request : ".concat(e.name," "));var u=this.onReqFinished_.bind(this),h=e.query,p=function(m){r=new m(h,o.util)};switch(e.name){case f.Select:p(ae);break;case f.Insert:p(Lt);break;case f.Update:p(Ve);break;case f.Remove:p(Fe);break;case f.Count:p(We)}r.isTxQuery=!0,r.execute(this.beforeExecute).then(u).catch(function(m){u({error:m})})},t.prototype.pushReq_=function(e){var r=C(function(o,u){e.onSuccess=function(h){o(h)},e.onError=function(h){u(h)}});return this.reqQueue.push(e),this.isTxStarted_===!0&&this.processExecutionOfQry_(),this.log("request pushed : ".concat(e.name)),r},t.prototype.processExecutionOfQry_=function(){this.isQueryExecuting===!1&&this.reqQueue.length>0&&this.executeRequest_(this.reqQueue[0])},t.prototype.notExistingTable_=function(e){var r=this,o=null;return e.every(function(u){return r.table(u)!=null||(o=u,!1)}),o},t}(Be),kt=function(n){var t={name:n.name,version:n.version,tables:[]};return n.tables.forEach(function(e){var r={name:e.name,columns:{}};e.columns.forEach(function(o){r.columns[o.name]=o}),t.tables.push(r)}),t},tn=function(){function n(t){this.middlewares=[],this.util=new he,this.onQryFinished=Mt?function(e){self.postMessage(e)}:t}return Object.defineProperty(n.prototype,"db",{get:function(){return this.util.db},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"logger",{get:function(){return this.util.logger},enumerable:!1,configurable:!0}),n.prototype.executeMiddleware_=function(t){var e=this,r=Oe(this.middlewares)-1;if(r<0)return T();var o={},u=this.db;return Object.defineProperty(o,"database",{get:function(){return kt(u)}}),C(function(h){var p=0,m=function(){if(p<=r){var _=tt(e.middlewares[p++])(t,o);_&&_.then||(_=Promise.resolve(_)),_.then(function(k){m()})}else h()};m()})},n.prototype.executeQuery=function(t,e){var r,o=t.query,u=this,h=u.util,p=function(m,_){r=new m(o,h).execute(_)};switch(t.name){case f.OpenDb:e(),r=u.openDb(o);break;case f.InitDb:e(),r=u.initDb(o);break;case f.CloseDb:e(),r=u.closeDb();break;case f.Insert:p(Lt,e);break;case f.Select:p(ae,e);break;case f.Count:p(We,e);break;case f.Update:p(Ve,e);break;case f.Intersect:e(),p(Yn);break;case f.DropDb:e(),r=u.dropDb();break;case f.Terminate:e(),r=u.terminate();break;case f.Union:e(),p(Zn);break;case f.Remove:p(Fe,e);break;case f.Clear:p(nr,e);break;case f.Transaction:p(or,e);break;case f.Get:e(),r=S.get(o,h);break;case f.Set:e(),r=S.set(o.key,o.value,h);break;case f.ImportScripts:e(),r=u.importScripts_(t);break;case f.ChangeLogStatus:e(),u.logger.status=o,r=Promise.resolve();break;case f.Middleware:return e(),tt(o)?(u.middlewares.push(o),T()):ye(new N(M,o));default:r=T()}return u.logger.log("Executing query ".concat(t.name," in web worker")),r},n.prototype.callMiddleware_=function(t,e){return C(function(r){var o=0,u=Oe(t)-1,h=function(){if(o<=u){var p=t[o++](e);p instanceof Promise||(p=T(p)),p.then(function(m){e=m,h()})}else r(e)};h()})},n.prototype.run=function(t){var e=this,r=[],o=[];t.onResult=function(u){r.push(function(h){return u(h)})},t.beforeExecute=function(u){o.push(function(h){return u(h)})},this.executeMiddleware_(t).then(function(u){return e.executeQuery(t,function(){return e.callMiddleware_(o)}).then(function(h){return e.callMiddleware_(r,h).then(function(p){e.returnResult_({result:p})})})}).catch(function(u){r=[];var h={error:ut(u)};e.returnResult_(h)})},n.prototype.importScripts_=function(t){return C(function(e,r){try{importScripts.apply(void 0,t.query),e()}catch(o){r(new N(w,o.message))}})},n.prototype.returnResult_=function(t){this.logger.log("Query finished inside web worker"),this.util&&this.util.emptyTx(),this.onQryFinished(t)},n.prototype.dropDb=function(){var t=this.db.name;return this.terminate().then(function(){return new Xn().execute(t)})},n.prototype.closeDb=function(){return this.util.close()},n.prototype.terminate=function(){var t=this;return this.closeDb().then(function(){t.util.db=null})},n.prototype.openDb=function(t){var e=this;return this.closeDb().then(function(r){return(e.db&&t.name===e.db.name?e.initDb():e.initDb({name:t.name,tables:[],version:t.version})).then(function(){return e.db})})},n.prototype.initDb=function(t){var e=this;if(!An)return ye(new N(F));var r=t?new J(t):this.db;return this.util=new he,C(function(o,u){e.util.initDb(r).then(function(h){h.isCreated?S.get(S.dbSchema,e.util).then(function(p){p&&p.tables.forEach(function(m,_){var k=r.tables.find(function(L){return L.name===m.name});if(k)for(var E in m.autoIncColumnValue){var q=m.autoIncColumnValue[E];q&&(k.autoIncColumnValue[E]=q)}}),e.util.db=r,h.database=kt(e.db),S.set(S.dbSchema,r,e.util).then(function(){o(h)})}):S.get(S.dbSchema,e.util).then(function(p){e.util.db=p,h.database=kt(e.db),o(h)})}).catch(u)})},n}();if(Mt){var ir=new tn;self.onmessage=function(n){ir.run(n.data)}}Ot.exports=i})()),Ot.exports}var vr={setup(s,i){s.$worker=yr(),s.initQueryManager_()}};const gr=vr,De=yt("move"),It=yt({width:30,color:"#000",drag:!1}),Ie=new Je.exports.Connection;Ie.addPlugin(gr);const it=yt(),Ye=yt();let En;Ye.subscribe(s=>En=s);async function Sn(){let s=await Ie.select({from:"Files"});return s.length==0?(await $t(),s=await Ie.select({from:"Files"})):it.set(s),s}async function _r(){await Ie.initDb({name:"Canvas",tables:[{name:"Files",columns:{id:{autoIncrement:!0,primaryKey:!0},name:{dataType:Je.exports.DATA_TYPE.String,notNull:!0},blocks:{dataType:Je.exports.DATA_TYPE.Object,notNull:!0},createdData:{dataType:Je.exports.DATA_TYPE.DateTime,notNull:!0},lastUpdate:{dataType:Je.exports.DATA_TYPE.DateTime,notNull:!0}}}]})&&$t();let i=await Sn();Ye.set(i[0])}_r();async function br(s,i){await Ie.update({in:"Files",set:{blocks:i},where:{id:s}}),it.set(await Ie.select({from:"Files"}))}async function $t(s="New Canvas"){await Ie.insert({into:"Files",values:[{name:s,blocks:{},createdData:new Date,lastUpdate:new Date}]}),it.set(await Ie.select({from:"Files"}))}async function wr(s){if(await Ie.remove({from:"Files",where:{id:s}}),En.id==s){let i=await Sn();Ye.set(i[0])}}function kr(s){let i,a;return{c(){i=je("svg"),a=je("path"),R(a,"d","M18 11h-5V6h3l-4-4-4 4h3v5H6V8l-4 4 4 4v-3h5v5H8l4 4 4-4h-3v-5h5v3l4-4-4-4z"),R(i,"viewBox","0 0 24 24")},m(c,f){re(c,i,f),P(i,a)},p:K,i:K,o:K,d(c){c&&te(i)}}}class xr extends Se{constructor(i){super(),Ee(this,i,null,kr,ke,{})}}function Cr(s){let i,a;return{c(){i=je("svg"),a=je("path"),R(a,"d","M8.707 19.707 18 10.414 13.586 6l-9.293 9.293a1.003 1.003 0 0 0-.263.464L3 21l5.242-1.03c.176-.044.337-.135.465-.263zM21 7.414a2 2 0 0 0 0-2.828L19.414 3a2 2 0 0 0-2.828 0L15 4.586 19.414 9 21 7.414z"),R(i,"viewBox","0 0 24 24")},m(c,f){re(c,i,f),P(i,a)},p:K,i:K,o:K,d(c){c&&te(i)}}}class Tr extends Se{constructor(i){super(),Ee(this,i,null,Cr,ke,{})}}function Er(s){let i,a;return{c(){i=je("svg"),a=je("path"),R(a,"d","M12.48 3 7.73 7.75 3 12.59a2 2 0 0 0 0 2.82l4.3 4.3A1 1 0 0 0 8 20h12v-2h-7l7.22-7.22a2 2 0 0 0 0-2.83L15.31 3a2 2 0 0 0-2.83 0zM8.41 18l-4-4 4.75-4.84.74-.75 4.95 4.95-4.56 4.56-.07.08z"),R(i,"viewBox","0 0 24 24")},m(c,f){re(c,i,f),P(i,a)},p:K,i:K,o:K,d(c){c&&te(i)}}}class Sr extends Se{constructor(i){super(),Ee(this,i,null,Er,ke,{})}}function Or(s){let i,a,c,f,g,l,y,x,b,T,C,j;return c=new xr({}),l=new Tr({}),b=new Sr({}),{c(){i=U("nav"),a=U("button"),qe(c.$$.fragment),f=de(),g=U("button"),qe(l.$$.fragment),y=de(),x=U("button"),qe(b.$$.fragment),R(a,"class","svelte-btjwju"),_e(a,"selected",s[0]=="move"),R(g,"class","svelte-btjwju"),_e(g,"selected",s[0]=="pen"),R(x,"class","svelte-btjwju"),_e(x,"selected",s[0]=="eraser"),R(i,"class","svelte-btjwju")},m($,D){re($,i,D),P(i,a),xe(c,a,null),P(i,f),P(i,g),xe(l,g,null),P(i,y),P(i,x),xe(b,x,null),T=!0,C||(j=[se(a,"click",s[1]),se(g,"click",s[2]),se(x,"click",s[3])],C=!0)},p($,[D]){(!T||D&1)&&_e(a,"selected",$[0]=="move"),(!T||D&1)&&_e(g,"selected",$[0]=="pen"),(!T||D&1)&&_e(x,"selected",$[0]=="eraser")},i($){T||(fe(c.$$.fragment,$),fe(l.$$.fragment,$),fe(b.$$.fragment,$),T=!0)},o($){me(c.$$.fragment,$),me(l.$$.fragment,$),me(b.$$.fragment,$),T=!1},d($){$&&te(i),Ce(c),Ce(l),Ce(b),C=!1,Te(j)}}}function qr(s,i,a){let c;return De.subscribe(y=>a(0,c=y)),[c,()=>De.set("move"),()=>De.set("pen"),()=>De.set("eraser")]}class jr extends Se{constructor(i){super(),Ee(this,i,qr,Or,ke,{})}}function Ar(s){let i,a;return{c(){i=je("svg"),a=je("path"),R(a,"d","M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"),R(i,"viewBox","0 0 24 24")},m(c,f){re(c,i,f),P(i,a)},p:K,i:K,o:K,d(c){c&&te(i)}}}class Ir extends Se{constructor(i){super(),Ee(this,i,null,Ar,ke,{})}}function Dr(s){let i,a;return{c(){i=je("svg"),a=je("path"),R(a,"d","m16.192 6.344-4.243 4.242-4.242-4.242-1.414 1.414L10.535 12l-4.242 4.242 1.414 1.414 4.242-4.242 4.243 4.242 1.414-1.414L13.364 12l4.242-4.242z"),R(i,"viewBox","0 0 24 24")},m(c,f){re(c,i,f),P(i,a)},p:K,i:K,o:K,d(c){c&&te(i)}}}class Nr extends Se{constructor(i){super(),Ee(this,i,null,Dr,ke,{})}}function Rr(s){const i=a=>{s.contains(a.target)||s.dispatchEvent(new CustomEvent("outclick"))};return document.addEventListener("click",i,!0),{destroy(){document.removeEventListener("click",i,!0)}}}function sn(s,i,a){const c=s.slice();return c[11]=i[a],c}function Qr(s){let i,a,c,f,g,l,y,x,b,T,C,j,$,D,Q,W,B,H;f=new Nr({});let le=s[1],oe=[];for(let F=0;F<le.length;F+=1)oe[F]=an(sn(s,le,F));return{c(){i=U("div"),a=U("span"),c=U("button"),qe(f.$$.fragment),g=de(),l=U("h3"),l.textContent="Settings",y=de(),x=U("h4"),x.textContent="Files",b=de(),T=U("span");for(let F=0;F<oe.length;F+=1)oe[F].c();C=de(),j=U("span"),$=U("button"),$.textContent="Save",D=de(),Q=U("button"),Q.textContent="New",R(c,"class","close svelte-tnansi"),R(l,"class","title svelte-tnansi"),R(a,"class","svelte-tnansi"),R(x,"class","title svelte-tnansi"),R(T,"class","files svelte-tnansi"),R($,"class","save svelte-tnansi"),R(Q,"class","new svelte-tnansi"),R(j,"class","optbtn svelte-tnansi"),R(i,"class","view svelte-tnansi")},m(F,v){re(F,i,v),P(i,a),P(a,c),xe(f,c,null),P(a,g),P(a,l),P(i,y),P(i,x),P(i,b),P(i,T);for(let d=0;d<oe.length;d+=1)oe[d].m(T,null);P(i,C),P(i,j),P(j,$),P(j,D),P(j,Q),W=!0,B||(H=[se(c,"click",s[5]),se($,"click",s[8]),se(Q,"click",s[9])],B=!0)},p(F,v){if(v&6){le=F[1];let d;for(d=0;d<le.length;d+=1){const w=sn(F,le,d);oe[d]?oe[d].p(w,v):(oe[d]=an(w),oe[d].c(),oe[d].m(T,null))}for(;d<oe.length;d+=1)oe[d].d(1);oe.length=le.length}},i(F){W||(fe(f.$$.fragment,F),W=!0)},o(F){me(f.$$.fragment,F),W=!1},d(F){F&&te(i),Ce(f),Nt(oe,F),B=!1,Te(H)}}}function $r(s){let i,a,c,f,g;return a=new Ir({}),{c(){i=U("button"),qe(a.$$.fragment),R(i,"class","open svelte-tnansi")},m(l,y){re(l,i,y),xe(a,i,null),c=!0,f||(g=se(i,"click",s[4]),f=!0)},p:K,i(l){c||(fe(a.$$.fragment,l),c=!0)},o(l){me(a.$$.fragment,l),c=!1},d(l){l&&te(i),Ce(a),f=!1,g()}}}function an(s){let i,a=s[11].name+"",c,f,g=`${s[11].createdData.getDate()}.${s[11].createdData.getMonth()}.${s[11].createdData.getFullYear()}`,l,y,x,b,T,C;function j(){return s[6](s[11])}function $(){return s[7](s[11])}return{c(){i=U("button"),c=Ne(a),f=Ne(" / "),l=Ne(g),y=de(),x=U("button"),x.textContent="X",b=de(),R(x,"class","del svelte-tnansi"),R(i,"class","svelte-tnansi"),_e(i,"sel",s[2].id==s[11].id)},m(D,Q){re(D,i,Q),P(i,c),P(i,f),P(i,l),P(i,y),P(i,x),P(i,b),T||(C=[se(x,"click",j),se(i,"dblclick",$)],T=!0)},p(D,Q){s=D,Q&2&&a!==(a=s[11].name+"")&&on(c,a),Q&2&&g!==(g=`${s[11].createdData.getDate()}.${s[11].createdData.getMonth()}.${s[11].createdData.getFullYear()}`)&&on(l,g),Q&6&&_e(i,"sel",s[2].id==s[11].id)},d(D){D&&te(i),T=!1,Te(C)}}}function Lr(s){let i,a,c,f,g,l;const y=[$r,Qr],x=[];function b(T,C){return T[0]?1:0}return a=b(s),c=x[a]=y[a](s),{c(){i=U("div"),c.c(),R(i,"class","settingBuble svelte-tnansi")},m(T,C){re(T,i,C),x[a].m(i,null),f=!0,g||(l=[cr(Rr.call(null,i)),se(i,"outclick",s[10])],g=!0)},p(T,[C]){let j=a;a=b(T),a===j?x[a].p(T,C):(Rt(),me(x[j],1,1,()=>{x[j]=null}),Qt(),c=x[a],c?c.p(T,C):(c=x[a]=y[a](T),c.c()),fe(c,1),c.m(i,null))},i(T){f||(fe(c),f=!0)},o(T){me(c),f=!1},d(T){T&&te(i),x[a].d(),g=!1,Te(l)}}}function Mr(s,i,a){const c=kn();let f=!1,g;it.subscribe(D=>a(1,g=D));let l;return Ye.subscribe(D=>a(2,l=D)),[f,g,l,c,()=>a(0,f=!0),()=>a(0,f=!1),D=>wr(D.id),D=>Ye.set(D),async()=>c("save"),async()=>{let D=prompt("What do you name the new canvas: ");await $t(D)},()=>a(0,f=!1)]}class Pr extends Se{constructor(i){super(),Ee(this,i,Mr,Lr,ke,{})}}const{window:Br}=Cn;function Wr(s){let i,a,c,f,g;return{c(){i=U("canvas"),a=de(),c=U("div"),R(i,"class","svelte-attco8"),_e(i,"nocursor",s[1]!="move"),_e(i,"movecursor",s[1]=="move"),R(c,"class","brush svelte-attco8"),_e(c,"hide",s[1]=="move"),pe(c,"width",`${s[2].width}px`),pe(c,"height",`${s[2].width}px`),pe(c,"top",`${s[5]}px`),pe(c,"left",`${s[4]}px`),pe(c,"border",`1px solid ${s[2].color}`)},m(l,y){re(l,i,y),s[10](i),re(l,a,y),re(l,c,y),s[11](c),f||(g=[se(Br,"resize",s[6]),se(i,"mousedown",s[8]),se(i,"mousemove",s[7]),se(i,"mouseup",s[9])],f=!0)},p(l,[y]){y&2&&_e(i,"nocursor",l[1]!="move"),y&2&&_e(i,"movecursor",l[1]=="move"),y&2&&_e(c,"hide",l[1]=="move"),y&4&&pe(c,"width",`${l[2].width}px`),y&4&&pe(c,"height",`${l[2].width}px`),y&32&&pe(c,"top",`${l[5]}px`),y&16&&pe(c,"left",`${l[4]}px`),y&4&&pe(c,"border",`1px solid ${l[2].color}`)},i:K,o:K,d(l){l&&te(i),s[10](null),l&&te(a),l&&te(c),s[11](null),f=!1,Te(g)}}}function Vr(s,i,a){let c=kn(),f;De.subscribe(d=>a(1,f=d));let g;It.subscribe(d=>a(2,g=d));let l,y,x=!1,b,T=0,C=0,j=newVector(500,500);function $(){a(0,l.width=window.innerWidth,l),a(0,l.height=window.innerHeight,l)}function D(d){a(4,T=d.clientX),a(5,C=d.clientY),!!x&&(f=="pen"||f=="eraser")&&W(d)}function Q(d,w){let O=newVector(d,w);if(j.distance(O)>8){let Y=j.sub(O).norm().mul(10);return O.add(Y)}return j}function W({clientX:d,clientY:w}){g.drag&&f!="eraser"?j=Q(d,w):(j.x=d,j.y=w),y.lineTo(j.x,j.y),y.stroke(),y.beginPath(),y.moveTo(j.x,j.y)}function B(){y.globalCompositeOperation="source-over",y.lineWidth=g.width,y.lineCap="round",y.strokeStyle="white",a(0,l.style.opacity=".5",l)}function H(){y.lineWidth=g.width,y.lineCap="round",y.strokeStyle=g.color,a(0,l.style.opacity="",l)}function le(d){d.button==0&&(x=!0,f=="pen"?H():f=="eraser"&&B(),j.x=d.clientX,j.y=d.clientY,y.beginPath(),y.moveTo(d.clientX,d.clientY),D(d))}async function oe({button:d}){d==0&&(x=!1,f=="pen"?c("imgout",{width:l.width,height:l.height,image:await createImageBitmap(y.getImageData(0,0,l.width,l.height))}):f=="eraser"&&c("imgoute",{width:l.width,height:l.height,image:await createImageBitmap(y.getImageData(0,0,l.width,l.height))}),setTimeout(()=>{y.clearRect(0,0,l.width,l.height)},60))}wn(()=>$());function F(d){Re[d?"unshift":"push"](()=>{l=d,a(0,l)})}function v(d){Re[d?"unshift":"push"](()=>{b=d,a(3,b)})}return s.$$.update=()=>{s.$$.dirty&1&&l&&(y=l.getContext("2d"))},[l,f,g,b,T,C,$,D,le,oe,F,v]}class Fr extends Se{constructor(i){super(),Ee(this,i,Vr,Wr,ke,{})}}const{window:pt}=Cn;function cn(s,i,a){const c=s.slice();return c[27]=i[a],c}function ln(s,i,a){const c=s.slice();c[30]=i[a],c[33]=i,c[34]=a;const f=c[30];return c[31]=f.x,c[32]=f.y,c}function fn(s){let i,a=s[33],c=s[34];const f=()=>s[21](i,a,c),g=()=>s[21](null,a,c);return{c(){i=U("canvas"),R(i,"width",ee),R(i,"height",ee),pe(i,"top",`${s[32]*ee}px`),pe(i,"left",`${s[31]*ee}px`)},m(l,y){re(l,i,y),f()},p(l,y){s=l,(a!==s[33]||c!==s[34])&&(g(),a=s[33],c=s[34],f()),y[0]&128&&pe(i,"top",`${s[32]*ee}px`),y[0]&128&&pe(i,"left",`${s[31]*ee}px`)},d(l){l&&te(i),g()}}}function hn(s){let i,a=s[27],c=[];for(let f=0;f<a.length;f+=1)c[f]=fn(ln(s,a,f));return{c(){for(let f=0;f<c.length;f+=1)c[f].c();i=gn()},m(f,g){for(let l=0;l<c.length;l+=1)c[l].m(f,g);re(f,i,g)},p(f,g){if(g[0]&128){a=f[27];let l;for(l=0;l<a.length;l+=1){const y=ln(f,a,l);c[l]?c[l].p(y,g):(c[l]=fn(y),c[l].c(),c[l].m(i.parentNode,i))}for(;l<c.length;l+=1)c[l].d(1);c.length=a.length}},d(f){Nt(c,f),f&&te(i)}}}function Ur(s){let i,a,c,f,g=s[7],l=[];for(let y=0;y<g.length;y+=1)l[y]=hn(cn(s,g,y));return{c(){i=U("div"),a=U("div");for(let y=0;y<l.length;y+=1)l[y].c();R(a,"class","shift svelte-osbjy1"),pe(a,"top",`${-s[2]}px`),pe(a,"left",`${-s[1]}px`),R(i,"class","view svelte-osbjy1")},m(y,x){re(y,i,x),P(i,a);for(let b=0;b<l.length;b+=1)l[b].m(a,null);c||(f=[se(pt,"resize",s[11]),se(pt,"mousedown",s[18]),se(pt,"mouseup",s[19]),se(pt,"mousemove",s[20])],c=!0)},p(y,x){if(x[0]&128){g=y[7];let b;for(b=0;b<g.length;b+=1){const T=cn(y,g,b);l[b]?l[b].p(T,x):(l[b]=hn(T),l[b].c(),l[b].m(a,null))}for(;b<l.length;b+=1)l[b].d(1);l.length=g.length}x[0]&4&&pe(a,"top",`${-y[2]}px`),x[0]&2&&pe(a,"left",`${-y[1]}px`)},i:K,o:K,d(y){y&&te(i),Nt(l,y),c=!1,Te(f)}}}let ee=480;function Gr(s,i,a){let c;De.subscribe(S=>a(0,c=S));let f,g,l=0,y=0,x=0,b=0,T=0,C=0,j=T,$=C,D={},Q=[],W,B=!1;function H(){a(16,x=Math.floor(T/ee)),a(17,b=Math.floor(C/ee)),a(1,l=Math.abs(x*ee-T)),a(2,y=Math.abs(b*ee-C))}function le(){g=(window.innerWidth+ee)/ee,g=g%1>0?Math.floor(g)+1:g}function oe(){let S=[];for(let J=0;J<g;J++){let z=[];for(let N=0;N<g;N++)z.push({x:J,y:N,element:null});S.push(z)}a(7,Q=S)}async function F(){for(let S of Q)for(let J of S){let z=`${x+J.x},${b+J.y}`;if(z in D){if(J.element!=null){let N=J.element.getContext("2d");N.clearRect(0,0,ee,ee),D[z]!=null&&N.drawImage(await createImageBitmap(D[z]),0,0)}}else D[z]=null,J.element!=null&&J.element.getContext("2d").clearRect(0,0,ee,ee)}}const v=async S=>{for(let J of Q)for(let z of J){let N=`${x+z.x},${b+z.y}`,he=z.element.getContext("2d");he.globalCompositeOperation="source-over",he.drawImage(S,-(z.x*ee-l),-(z.y*ee-y)),D[N]=he.getImageData(0,0,ee,ee)}},d=async S=>{for(let J of Q)for(let z of J){let N=`${x+z.x},${b+z.y}`,he=z.element.getContext("2d");he.globalCompositeOperation="destination-out",he.drawImage(S,-(z.x*ee-l)-1,-(z.y*ee-y)-1),D[N]=he.getImageData(0,0,ee,ee)}},w=()=>{br(f,{...D})};H(),le(),oe(),Ye.subscribe(async S=>{!S||(f=S.id,a(5,j=T),a(6,$=C),D={...S.blocks},H(),F())});const O=({button:S,clientX:J,clientY:z})=>{(S==1||S==0&&c=="move")&&(a(9,B=!0),a(8,W={x:J,y:z}))},M=({button:S})=>{(S==1||S==0&&c=="move")&&(a(9,B=!1),a(5,j=T),a(6,$=C))},Y=({clientX:S,clientY:J})=>{B&&(a(3,T=W.x-S+j),a(4,C=W.y-J+$),H())};function ie(S,J,z){Re[S?"unshift":"push"](()=>{J[z].element=S,a(7,Q)})}return s.$$.update=()=>{s.$$.dirty[0]&196608&&x!=null&&b!=null&&F()},[c,l,y,T,C,j,$,Q,W,B,H,le,F,v,d,w,x,b,O,M,Y,ie]}class Kr extends Se{constructor(i){super(),Ee(this,i,Gr,Ur,ke,{drawToMC:13,eraserMC:14,saveCanvas:15},null,[-1,-1])}get drawToMC(){return this.$$.ctx[13]}get eraserMC(){return this.$$.ctx[14]}get saveCanvas(){return this.$$.ctx[15]}}function pn(s){let i,a,c,f,g;return{c(){i=U("label"),a=Ne("Color: "),c=U("input"),R(c,"type","color"),R(c,"class","svelte-19m7187"),R(i,"for",""),R(i,"class","svelte-19m7187")},m(l,y){re(l,i,y),P(i,a),P(i,c),ze(c,s[1]),f||(g=se(c,"input",s[5]),f=!0)},p(l,y){y&2&&ze(c,l[1])},d(l){l&&te(i),f=!1,g()}}}function dn(s){let i,a,c,f,g;return{c(){i=U("label"),a=Ne("Drag: "),c=U("input"),R(c,"type","checkbox"),R(c,"class","svelte-19m7187"),R(i,"for",""),R(i,"class","svelte-19m7187")},m(l,y){re(l,i,y),P(i,a),P(i,c),ze(c,s[2]),f||(g=se(c,"change",s[6]),f=!0)},p(l,y){y&4&&ze(c,l[2])},d(l){l&&te(i),f=!1,g()}}}function Jr(s){let i,a,c,f,g,l,y,x,b=s[3]=="pen"&&pn(s),T=s[3]=="pen"&&dn(s);return{c(){i=U("div"),a=U("label"),c=Ne("Size: "),f=U("input"),g=de(),b&&b.c(),l=de(),T&&T.c(),R(f,"type","number"),R(f,"class","svelte-19m7187"),R(a,"for",""),R(a,"class","svelte-19m7187"),R(i,"class","props svelte-19m7187")},m(C,j){re(C,i,j),P(i,a),P(a,c),P(a,f),ze(f,s[0]),P(i,g),b&&b.m(i,null),P(i,l),T&&T.m(i,null),y||(x=se(f,"input",s[4]),y=!0)},p(C,[j]){j&1&&_n(f.value)!==C[0]&&ze(f,C[0]),C[3]=="pen"?b?b.p(C,j):(b=pn(C),b.c(),b.m(i,l)):b&&(b.d(1),b=null),C[3]=="pen"?T?T.p(C,j):(T=dn(C),T.c(),T.m(i,null)):T&&(T.d(1),T=null)},i:K,o:K,d(C){C&&te(i),b&&b.d(),T&&T.d(),y=!1,x()}}}function zr(s,i,a){let c;It.subscribe(C=>c=C);let f;De.subscribe(C=>a(3,f=C));let g=c.width,l=c.color,y=c.drag;function x(){g=_n(this.value),a(0,g)}function b(){l=this.value,a(1,l)}function T(){y=this.value,a(2,y)}return s.$$.update=()=>{s.$$.dirty&7&&It.set({width:g,color:l,drag:y})},[g,l,y,f,x,b,T]}class Yr extends Se{constructor(i){super(),Ee(this,i,zr,Jr,ke,{})}}function mn(s){let i,a,c,f,g,l;i=new Pr({}),i.$on("save",s[11]),c=new jr({});let y=(s[1]=="pen"||s[1]=="eraser")&&yn();return{c(){qe(i.$$.fragment),a=de(),qe(c.$$.fragment),f=de(),y&&y.c(),g=gn()},m(x,b){xe(i,x,b),re(x,a,b),xe(c,x,b),re(x,f,b),y&&y.m(x,b),re(x,g,b),l=!0},p(x,b){x[1]=="pen"||x[1]=="eraser"?y?b&2&&fe(y,1):(y=yn(),y.c(),fe(y,1),y.m(g.parentNode,g)):y&&(Rt(),me(y,1,1,()=>{y=null}),Qt())},i(x){l||(fe(i.$$.fragment,x),fe(c.$$.fragment,x),fe(y),l=!0)},o(x){me(i.$$.fragment,x),me(c.$$.fragment,x),me(y),l=!1},d(x){Ce(i,x),x&&te(a),Ce(c,x),x&&te(f),y&&y.d(x),x&&te(g)}}}function yn(s){let i,a;return i=new Yr({}),{c(){qe(i.$$.fragment)},m(c,f){xe(i,c,f),a=!0},i(c){a||(fe(i.$$.fragment,c),a=!0)},o(c){me(i.$$.fragment,c),a=!1},d(c){Ce(i,c)}}}function Xr(s){let i,a,c,f,g,l,y,x,b,T,C;function j(B){s[6](B)}function $(B){s[7](B)}function D(B){s[8](B)}let Q={};s[2]!==void 0&&(Q.drawToMC=s[2]),s[3]!==void 0&&(Q.eraserMC=s[3]),s[4]!==void 0&&(Q.saveCanvas=s[4]),a=new Kr({props:Q}),Re.push(()=>St(a,"drawToMC",j)),Re.push(()=>St(a,"eraserMC",$)),Re.push(()=>St(a,"saveCanvas",D)),y=new Fr({}),y.$on("imgout",s[9]),y.$on("imgoute",s[10]);let W=!s[0]&&mn(s);return{c(){i=U("main"),qe(a.$$.fragment),l=de(),qe(y.$$.fragment),x=de(),W&&W.c(),R(i,"class","svelte-1kjpltg")},m(B,H){re(B,i,H),xe(a,i,null),P(i,l),xe(y,i,null),P(i,x),W&&W.m(i,null),b=!0,T||(C=se(window,"keydown",s[5]),T=!0)},p(B,[H]){const le={};!c&&H&4&&(c=!0,le.drawToMC=B[2],Tt(()=>c=!1)),!f&&H&8&&(f=!0,le.eraserMC=B[3],Tt(()=>f=!1)),!g&&H&16&&(g=!0,le.saveCanvas=B[4],Tt(()=>g=!1)),a.$set(le),B[0]?W&&(Rt(),me(W,1,1,()=>{W=null}),Qt()):W?(W.p(B,H),H&1&&fe(W,1)):(W=mn(B),W.c(),fe(W,1),W.m(i,null))},i(B){b||(fe(a.$$.fragment,B),fe(y.$$.fragment,B),fe(W),b=!0)},o(B){me(a.$$.fragment,B),me(y.$$.fragment,B),me(W),b=!1},d(B){B&&te(i),Ce(a),Ce(y),W&&W.d(),T=!1,C()}}}function Hr(s,i,a){let c=!1,f;De.subscribe(Q=>a(1,f=Q)),it.subscribe(Q=>Q);let g,l,y;wn(()=>{});const x=({shiftKey:Q})=>{Q&&a(0,c=!c)};function b(Q){g=Q,a(2,g)}function T(Q){l=Q,a(3,l)}function C(Q){y=Q,a(4,y)}return[c,f,g,l,y,x,b,T,C,({detail:Q})=>{g(Q.image)},({detail:Q})=>{l(Q.image)},()=>y()]}class Zr extends Se{constructor(i){super(),Ee(this,i,Hr,Xr,ke,{})}}window.gcd=function(s,i){return i==0?s:gcd(i,s%i)};window.aspectRatio=function(s,i){let a=gcd(s,i);return[s/a,i/a]};class Me{constructor(i=1,a=1){Ct(this,"x");Ct(this,"y");this.x=i,this.y=a}len(){return Math.sqrt(this.x**2+this.y**2)}norm(){let i=this.len();return new Me(this.x/i,this.y/i)}distance(i){var a=this.x-i.x,c=this.y-i.y,f=Math.sqrt(a*a+c*c);return Math.abs(f)}angle(i){return(-(Math.atan2(this.x-i.x,this.y-i.y)*(180/Math.PI))%360+360)%360}add(i){let a=this.x+i.x,c=this.y+i.y;return new Me(a,c)}sub(i){let a=this.x-i.x,c=this.y-i.y;return new Me(a,c)}mul(i){return new Me(this.x*i,this.y*i)}clone(){return new Me(this.x,this.y)}}window.newVector=(s=0,i=0)=>new Me(s,i);new Zr({target:document.getElementById("app")});
